<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>GURU MASTER PRO ¬∑ OI FLOW ELITE ENGINE</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@300;400;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --obsidian:#04060d;--void:#070b14;--deep:#0c1220;--panel:#101827;--raised:#161f30;
  --gold:#f5c842;--gold2:#d4a820;--gold3:rgba(245,200,66,.12);--gold4:rgba(245,200,66,.06);
  --jade:#00e5a0;--jade2:#00b87c;--jade3:rgba(0,229,160,.1);
  --crimson:#ff2d55;--crimson2:#cc1f3d;--crimson3:rgba(255,45,85,.1);
  --sky:#38bdf8;--sky2:rgba(56,189,248,.1);
  --amber:#fb923c;--violet:#8b5cf6;
  --border:#1c2d45;--border2:#253d5c;--border3:#2d4a6e;
  --t0:#f0f4ff;--t1:#c8d8f0;--t2:#7a9bcc;--t3:#3a5a7a;--t4:#1e3350;
  --mono:'JetBrains Mono',monospace;
  --orb:'Orbitron',monospace;
  --sans:'Space Grotesk',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--obsidian);color:var(--t1);font-family:var(--mono);font-size:11px;
  background-image:
    radial-gradient(ellipse 60% 40% at 20% 10%,rgba(245,200,66,.04) 0%,transparent 60%),
    radial-gradient(ellipse 40% 60% at 80% 90%,rgba(0,229,160,.03) 0%,transparent 60%),
    radial-gradient(ellipse 80% 30% at 50% 50%,rgba(16,24,39,.8) 0%,transparent 100%);}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:var(--void);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--border3);}

/* ‚ïê‚ïê‚ïê LOADING OVERLAY ‚ïê‚ïê‚ïê */
#lov{position:fixed;inset:0;z-index:9999;background:var(--obsidian);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;
  background-image:radial-gradient(ellipse at center,rgba(245,200,66,.06) 0%,transparent 70%);}
.guru-logo-load{font-family:var(--orb);font-size:22px;font-weight:900;
  background:linear-gradient(135deg,var(--gold),var(--jade),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  letter-spacing:.12em;animation:glowpulse 2s ease-in-out infinite;}
@keyframes glowpulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.4)}}
.load-bar-wrap{width:260px;height:2px;background:var(--border);border-radius:1px;overflow:hidden;}
.load-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--gold2),var(--jade));
  border-radius:1px;transition:width .3s ease;box-shadow:0 0 8px var(--gold2);}
#lstat{font-size:9px;color:var(--t3);letter-spacing:.08em;font-family:var(--mono);}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
#hdr{height:46px;display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;background:var(--void);border-bottom:1px solid var(--border);
  flex-shrink:0;position:relative;overflow:hidden;}
#hdr::before{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold2),var(--jade2),var(--gold2),transparent);}
.guru-brand{display:flex;flex-direction:column;}
.guru-title{font-family:var(--orb);font-size:12px;font-weight:900;letter-spacing:.1em;
  background:linear-gradient(90deg,var(--gold),#fff8d6,var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.guru-sub{font-size:8px;color:var(--t3);letter-spacing:.12em;margin-top:1px;font-family:var(--mono);}
.hdr-center{display:flex;gap:10px;align-items:center;}
.cd-pill{display:flex;align-items:center;gap:5px;padding:3px 10px;
  background:var(--deep);border:1px solid var(--border2);border-radius:20px;}
.cd-label{font-size:8px;color:var(--t3);letter-spacing:.06em;}
.cd-val{font-family:var(--orb);font-size:10px;font-weight:700;letter-spacing:.05em;}
.cd-15m{color:var(--jade);}
.cd-1h{color:var(--sky);}
.cd-4h{color:var(--gold);}
.hdr-right{display:flex;align-items:center;gap:8px;}
.live-badge{display:flex;align-items:center;gap:5px;padding:4px 10px;
  background:var(--deep);border:1px solid var(--border2);border-radius:20px;font-size:9px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--jade);
  box-shadow:0 0 6px var(--jade);animation:livepulse 2s infinite;}
@keyframes livepulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.85)}}
.confidence-gate{padding:3px 10px;border-radius:20px;font-family:var(--orb);font-size:9px;
  font-weight:700;letter-spacing:.06em;border:1px solid;transition:all .5s;}
.confidence-gate.armed{background:rgba(245,200,66,.12);border-color:rgba(245,200,66,.5);
  color:var(--gold);box-shadow:0 0 10px rgba(245,200,66,.2);}
.confidence-gate.standby{background:var(--deep);border-color:var(--border);color:var(--t3);}

/* ‚ïê‚ïê‚ïê SYMBOL BAR ‚ïê‚ïê‚ïê */
#sbar{height:34px;display:flex;align-items:stretch;padding:0 14px;
  background:var(--void);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;}
.sb{padding:0 13px;border:none;background:transparent;color:var(--t3);cursor:pointer;
  font-family:var(--mono);font-size:11px;border-bottom:2px solid transparent;
  transition:all .2s;white-space:nowrap;letter-spacing:.04em;}
.sb:hover{color:var(--t1);}
.sb.act{color:var(--gold);border-bottom-color:var(--gold);}
.ticker-strip{margin-left:auto;display:flex;align-items:center;gap:20px;padding:0 8px;}
.tk{text-align:center;}
.tk-l{font-size:7px;color:var(--t3);letter-spacing:.07em;text-transform:uppercase;}
.tk-v{font-family:var(--orb);font-size:11px;font-weight:700;}
.pos{color:var(--jade);}
.neg{color:var(--crimson);}
.neutral{color:var(--t2);}

/* ‚ïê‚ïê‚ïê BODY LAYOUT ‚ïê‚ïê‚ïê */
#body{display:grid;grid-template-columns:292px 1fr;height:calc(100vh - 80px);}

/* ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê */
#lp{display:flex;flex-direction:column;background:var(--void);
  border-right:1px solid var(--border);overflow:hidden;}
.tabs{display:flex;background:var(--obsidian);border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:6px 2px;text-align:center;font-size:8px;color:var(--t3);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .2s;letter-spacing:.05em;text-transform:uppercase;
  font-family:var(--mono);}
.tab:hover{color:var(--t1);}
.tab.act{color:var(--gold);border-bottom-color:var(--gold);}
.pane{display:none;flex-direction:column;overflow-y:auto;flex:1;}
.pane.act{display:flex;}

/* ‚ïê‚ïê‚ïê ELITE SIGNAL CARD ‚ïê‚ïê‚ïê */
.elite-card{margin:8px;border-radius:8px;overflow:hidden;border:1px solid var(--border2);
  background:var(--deep);transition:all .6s;position:relative;}
.elite-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--border3),transparent);transition:all .6s;}
.elite-card.long::before{background:linear-gradient(90deg,transparent,var(--jade),transparent);
  box-shadow:0 0 15px rgba(0,229,160,.3);}
.elite-card.short::before{background:linear-gradient(90deg,transparent,var(--crimson),transparent);
  box-shadow:0 0 15px rgba(255,45,85,.3);}
.elite-card.long{border-color:rgba(0,229,160,.4);box-shadow:0 0 20px rgba(0,229,160,.08);}
.elite-card.short{border-color:rgba(255,45,85,.4);box-shadow:0 0 20px rgba(255,45,85,.08);}
.elite-card.armed{border-color:rgba(245,200,66,.5);box-shadow:0 0 20px rgba(245,200,66,.12);}
.ec-top{padding:10px 12px;display:flex;justify-content:space-between;align-items:flex-start;}
.ec-signal{font-family:var(--orb);font-size:10px;font-weight:700;letter-spacing:.08em;}
.ec-dir{font-family:var(--orb);font-size:28px;font-weight:900;line-height:1;}
.ec-sub{font-size:8px;color:var(--t3);margin-top:2px;letter-spacing:.05em;}

/* ‚ïê‚ïê‚ïê PROBABILITY METER ‚ïê‚ïê‚ïê */
.prob-section{padding:0 12px 10px;}
.prob-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.prob-lbl{font-size:8px;color:var(--t3);letter-spacing:.07em;}
.prob-pct{font-family:var(--orb);font-size:18px;font-weight:900;}
.prob-bar{height:8px;border-radius:4px;background:rgba(255,255,255,.04);overflow:hidden;
  border:1px solid var(--border);margin-bottom:5px;position:relative;}
.prob-fill{height:100%;border-radius:4px;transition:width .8s cubic-bezier(.4,0,.2,1);
  position:relative;}
.prob-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:3px;
  background:white;border-radius:2px;opacity:.6;box-shadow:0 0 8px white;}
.threshold-line{position:absolute;top:0;bottom:0;width:1px;background:rgba(245,200,66,.6);
  left:95%;}
.threshold-tag{position:absolute;top:-14px;left:calc(95% - 10px);font-size:7px;color:var(--gold);
  font-family:var(--orb);}
.prob-tier{font-size:8px;letter-spacing:.06em;font-weight:700;}

/* ‚ïê‚ïê‚ïê CONFLUENCE GRID ‚ïê‚ïê‚ïê */
.conf-grid{margin:0 8px 8px;display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.conf-item{background:var(--raised);border:1px solid var(--border);border-radius:5px;
  padding:5px 7px;transition:border-color .4s;}
.conf-item.active{border-color:rgba(0,229,160,.4);}
.conf-item.blocked{border-color:rgba(255,45,85,.3);opacity:.6;}
.ci-label{font-size:7px;color:var(--t3);letter-spacing:.05em;margin-bottom:2px;}
.ci-val{font-size:9px;font-weight:700;}

/* ‚ïê‚ïê‚ïê ENTRY LEVELS ‚ïê‚ïê‚ïê */
.levels-block{margin:0 8px 8px;border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.levels-hdr{padding:4px 9px;background:rgba(0,0,0,.3);font-size:8px;color:var(--t3);
  letter-spacing:.07em;display:flex;justify-content:space-between;}
.lrow{display:flex;justify-content:space-between;align-items:center;
  padding:4px 9px;border-top:1px solid var(--border);}
.ll{color:var(--t3);font-size:8px;letter-spacing:.04em;}
.lv{font-size:10px;font-weight:700;font-family:var(--mono);}

/* ‚ïê‚ïê‚ïê MTF BLOCK ‚ïê‚ïê‚ïê */
.mtf-block{margin:0 8px 8px;border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.block-hdr{padding:4px 9px;background:rgba(0,0,0,.4);font-size:8px;color:var(--t3);
  letter-spacing:.07em;border-bottom:1px solid var(--border);}
.mtf-row{display:flex;align-items:center;gap:6px;padding:5px 9px;border-bottom:1px solid rgba(28,45,69,.5);}
.mtf-row:last-child{border-bottom:none;}
.mtf-tf{font-family:var(--orb);font-size:9px;font-weight:700;width:28px;color:var(--t2);}
.mtf-detail{flex:1;font-size:8px;color:var(--t2);}
.tag{padding:2px 7px;border-radius:3px;font-size:8px;font-weight:700;letter-spacing:.04em;}
.tag.bull{background:rgba(0,229,160,.12);color:var(--jade);border:1px solid rgba(0,229,160,.25);}
.tag.bear{background:rgba(255,45,85,.12);color:var(--crimson);border:1px solid rgba(255,45,85,.25);}
.tag.neu{background:rgba(122,155,204,.07);color:var(--t2);border:1px solid var(--border);}
.tag.gold{background:rgba(245,200,66,.12);color:var(--gold);border:1px solid rgba(245,200,66,.3);}
.tag.warn{background:rgba(251,146,60,.12);color:var(--amber);border:1px solid rgba(251,146,60,.3);}

/* ‚ïê‚ïê‚ïê CONFIRMATIONS ‚ïê‚ïê‚ïê */
.conf-list{margin:0 8px 8px;border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.citem{display:flex;align-items:center;gap:8px;padding:4px 9px;border-bottom:1px solid rgba(28,45,69,.4);}
.citem:last-child{border-bottom:none;}
.c-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.c-txt{flex:1;font-size:8px;color:var(--t2);}
.c-weight{font-size:8px;color:var(--gold);font-family:var(--orb);}

/* ‚ïê‚ïê‚ïê OI PRESSURE ‚ïê‚ïê‚ïê */
.oi-block{margin:0 8px 8px;border:1px solid var(--border);border-radius:6px;padding:8px 9px;
  background:var(--raised);}
.mini-bar{height:4px;border-radius:2px;background:rgba(255,255,255,.04);margin:3px 0 2px;overflow:hidden;}
.mini-fill{height:100%;border-radius:2px;transition:width .5s;}
.dual-row{display:flex;justify-content:space-between;font-size:8px;color:var(--t2);}

/* ‚ïê‚ïê‚ïê EVENTS LOG ‚ïê‚ïê‚ïê */
.elog{margin:0 8px 8px;border:1px solid var(--border);border-radius:6px;overflow:hidden;max-height:160px;}
.eitem{display:flex;gap:6px;padding:4px 9px;border-bottom:1px solid rgba(28,45,69,.3);align-items:flex-start;}
.eitem:last-child{border-bottom:none;}
.edot{width:5px;height:5px;border-radius:50%;flex-shrink:0;margin-top:3px;}
.etxt{font-size:8px;color:var(--t2);line-height:1.5;flex:1;}
.etime{font-size:7px;color:var(--t3);flex-shrink:0;}

/* ‚ïê‚ïê‚ïê SIGNALS TAB ‚ïê‚ïê‚ïê */
.sig-item{margin:6px 8px;border:1px solid var(--border);border-radius:6px;
  background:var(--raised);padding:8px 10px;transition:border-color .3s;}
.sig-item.long{border-color:rgba(0,229,160,.3);}
.sig-item.short{border-color:rgba(255,45,85,.3);}
.si-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.si-pair{font-family:var(--orb);font-size:10px;font-weight:700;}
.si-dir-badge{padding:2px 8px;border-radius:12px;font-size:8px;font-weight:700;font-family:var(--orb);}
.si-dir-badge.long{background:rgba(0,229,160,.15);color:var(--jade);}
.si-dir-badge.short{background:rgba(255,45,85,.15);color:var(--crimson);}
.si-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px;}
.si-row{font-size:8px;}
.si-lbl{color:var(--t3);}
.si-v{color:var(--t1);}

/* ‚ïê‚ïê‚ïê BACKTEST TAB ‚ïê‚ïê‚ïê */
.bt-sel-row{padding:6px 8px;display:flex;gap:6px;}
select.bt-sel{flex:1;background:var(--deep);border:1px solid var(--border);color:var(--t1);
  padding:5px 8px;border-radius:4px;font-family:var(--mono);font-size:9px;outline:none;}
.elite-btn{padding:7px 12px;border-radius:5px;font-family:var(--orb);font-size:9px;
  font-weight:700;cursor:pointer;letter-spacing:.07em;border:1px solid;transition:all .2s;}
.btn-gold{background:rgba(245,200,66,.1);border-color:rgba(245,200,66,.4);color:var(--gold);}
.btn-gold:hover{background:rgba(245,200,66,.2);box-shadow:0 0 12px rgba(245,200,66,.2);}
.btn-jade{background:rgba(0,229,160,.1);border-color:rgba(0,229,160,.4);color:var(--jade);}
.btn-jade:hover{background:rgba(0,229,160,.2);}
.btn-sky{background:rgba(56,189,248,.1);border-color:rgba(56,189,248,.4);color:var(--sky);}
.bt-metrics{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin:0 8px 6px;}
.bt-card{background:var(--raised);border:1px solid var(--border);border-radius:5px;padding:7px 9px;}
.bt-lbl{font-size:7px;color:var(--t3);letter-spacing:.06em;}
.bt-val{font-family:var(--orb);font-size:15px;font-weight:700;margin-top:2px;}
.monte-block{margin:0 8px 6px;background:var(--raised);border:1px solid var(--border);
  border-radius:5px;padding:8px 9px;}
.monte-title{font-size:8px;color:var(--t3);letter-spacing:.07em;margin-bottom:6px;}
.monte-bar-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;}
.monte-lbl{font-size:8px;color:var(--t2);width:80px;}
.monte-bar{flex:1;height:4px;background:rgba(255,255,255,.04);border-radius:2px;overflow:hidden;}
.monte-fill{height:100%;border-radius:2px;}
.monte-num{font-size:8px;color:var(--t2);width:36px;text-align:right;}

/* ‚ïê‚ïê‚ïê HISTORY TAB ‚ïê‚ïê‚ïê */
.htable{margin:6px 8px;border:1px solid var(--border);border-radius:5px;overflow:hidden;}
.hthdr{display:grid;grid-template-columns:60px 46px 34px 40px 38px;
  padding:4px 8px;background:rgba(0,0,0,.4);font-size:7px;color:var(--t3);gap:3px;letter-spacing:.04em;}
.htrow{display:grid;grid-template-columns:60px 46px 34px 40px 38px;
  padding:4px 8px;border-top:1px solid rgba(28,45,69,.4);font-size:8px;gap:3px;align-items:center;}
.exp-row{display:flex;gap:5px;padding:4px 8px 8px;}
.exp-btn{flex:1;padding:5px;background:var(--deep);border:1px solid var(--border);
  border-radius:4px;color:var(--t2);font-family:var(--mono);font-size:8px;cursor:pointer;
  text-align:center;transition:all .2s;}
.exp-btn:hover{border-color:var(--gold);color:var(--gold);}

/* ‚ïê‚ïê‚ïê TELEGRAM TAB ‚ïê‚ïê‚ïê */
.tg-section{padding:8px;}
.tg-info-box{background:rgba(245,200,66,.05);border:1px solid rgba(245,200,66,.2);
  border-radius:6px;padding:8px 10px;margin-bottom:8px;font-size:8px;color:var(--t2);line-height:1.8;}
.tg-input{width:100%;background:var(--deep);border:1px solid var(--border);color:var(--t1);
  padding:6px 9px;border-radius:4px;font-family:var(--mono);font-size:10px;outline:none;
  margin-bottom:5px;}
.tg-input:focus{border-color:var(--gold);}
.tg-toggle-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.toggle-label{font-size:9px;color:var(--t2);}
.tg-btns{display:flex;gap:5px;margin-bottom:6px;}
#tg-status{font-size:9px;padding:6px 9px;border-radius:4px;display:none;line-height:1.5;}
#tg-status.ok{background:rgba(0,229,160,.1);color:var(--jade);border:1px solid rgba(0,229,160,.3);display:block;}
#tg-status.err{background:rgba(255,45,85,.1);color:var(--crimson);border:1px solid rgba(255,45,85,.3);display:block;}
.scan-status{font-size:8px;padding:4px 0;margin-bottom:4px;}
#scan-badge{font-size:8px;color:var(--t3);}

/* ‚ïê‚ïê‚ïê JSON TAB ‚ïê‚ïê‚ïê */
#json-out{font-size:8px;color:var(--jade);background:var(--deep);border:1px solid var(--border);
  border-radius:4px;padding:8px;margin:6px 8px;overflow-y:auto;max-height:85%;
  line-height:1.7;white-space:pre-wrap;font-family:var(--mono);}

/* ‚ïê‚ïê‚ïê DISCLAIMER ‚ïê‚ïê‚ïê */
.disc{margin:0 8px 8px;padding:6px 9px;background:rgba(251,146,60,.04);
  border:1px solid rgba(251,146,60,.15);border-radius:4px;font-size:7px;
  color:rgba(251,146,60,.7);line-height:1.6;}

/* ‚ïê‚ïê‚ïê RIGHT: CHART AREA ‚ïê‚ïê‚ïê */
#chart-area{display:flex;flex-direction:column;background:var(--obsidian);overflow:hidden;}
#chart-hdr{height:32px;display:flex;align-items:center;gap:0;padding:0 10px;
  background:var(--void);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;gap:4px;}
.ch-item{display:flex;align-items:center;gap:3px;padding:0 8px;border-right:1px solid var(--border);}
.ch-item:last-child{border-right:none;}
.ch-lbl{font-size:7px;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;}
.ch-v{font-size:9px;font-weight:700;font-family:var(--mono);}
#cw{position:relative;flex:1;min-height:0;}
#mc{display:block;width:100%;height:100%;}
.sub-panel{flex-shrink:0;position:relative;border-top:1px solid var(--border);}
#oi-pnl{height:75px;}
#vol-pnl{height:55px;}
.sub-canvas{display:block;width:100%;height:100%;}
.sub-lbl{position:absolute;top:3px;left:8px;font-size:7px;color:var(--t3);
  letter-spacing:.07em;text-transform:uppercase;pointer-events:none;}
</style>
</head>
<body>
<!-- LOADING -->
<div id="lov">
  <div class="guru-logo-load">GURU MASTER PRO</div>
  <div style="font-size:9px;color:var(--t3);letter-spacing:.1em;margin-top:-8px">OI FLOW 4H+1H+15M ELITE ENGINE</div>
  <div class="load-bar-wrap"><div class="load-bar" id="lbar"></div></div>
  <div id="lstat">INITIALIZING ELITE ENGINE‚Ä¶</div>
</div>

<!-- HEADER -->
<div id="hdr">
  <div class="guru-brand">
    <div class="guru-title">GURU MASTER PRO</div>
    <div class="guru-sub">OI FLOW ¬∑ 4H+1H+15M ¬∑ ELITE ENGINE ¬∑ 95%+ CONFLUENCE ONLY</div>
  </div>
  <div class="hdr-center">
    <div class="cd-pill"><span class="cd-label">15M</span><span class="cd-val cd-15m" id="cd-15m">--:--</span></div>
    <div class="cd-pill"><span class="cd-label">1H</span><span class="cd-val cd-1h" id="cd-1h">--:--</span></div>
    <div class="cd-pill"><span class="cd-label">4H</span><span class="cd-val cd-4h" id="cd-4h">--:--</span></div>
  </div>
  <div class="hdr-right">
    <div class="confidence-gate standby" id="gate-badge">‚ßó SCANNING‚Ä¶</div>
    <div class="live-badge"><div class="live-dot"></div><span id="sys-st" style="color:var(--t2)">LIVE</span></div>
  </div>
</div>

<!-- SYMBOL BAR -->
<div id="sbar">
  <button class="sb act" onclick="setSym('ETHUSDT',this)">ETH/USDT</button>
  <button class="sb" onclick="setSym('BTCUSDT',this)">BTC/USDT</button>
  <button class="sb" onclick="setSym('SOLUSDT',this)">SOL/USDT</button>
  <button class="sb" onclick="setSym('BNBUSDT',this)">BNB/USDT</button>
  <button class="sb" onclick="setSym('XRPUSDT',this)">XRP/USDT</button>
  <div class="ticker-strip">
    <div class="tk"><div class="tk-l">PRICE</div><div class="tk-v neutral" id="tk-price">‚Äî</div></div>
    <div class="tk"><div class="tk-l">24H %</div><div class="tk-v" id="tk-chg">‚Äî</div></div>
    <div class="tk"><div class="tk-l">FUNDING</div><div class="tk-v" id="tk-fund">‚Äî</div></div>
    <div class="tk"><div class="tk-l">OPEN INT</div><div class="tk-v neutral" id="tk-oi">‚Äî</div></div>
    <div class="tk"><div class="tk-l">VOLUME</div><div class="tk-v neutral" id="tk-vol">‚Äî</div></div>
  </div>
</div>

<!-- BODY -->
<div id="body">
<!-- LEFT PANEL -->
<div id="lp">
  <div class="tabs">
    <div class="tab act" data-tab="dash" onclick="showTab(this,'dash')">ELITE</div>
    <div class="tab" data-tab="mtf" onclick="showTab(this,'mtf')">MTF</div>
    <div class="tab" data-tab="sigs" onclick="showTab(this,'sigs')">SIGNALS</div>
    <div class="tab" data-tab="bt" onclick="showTab(this,'bt')">BACKTEST</div>
    <div class="tab" data-tab="hist" onclick="showTab(this,'hist')">HISTORY</div>
    <div class="tab" data-tab="tg" onclick="showTab(this,'tg')">TG BOT</div>
    <div class="tab" data-tab="json" onclick="showTab(this,'json')">JSON</div>
  </div>

  <!-- ELITE DASHBOARD -->
  <div id="pane-dash" class="pane act">
    <!-- Signal Card -->
    <div class="elite-card" id="elite-card">
      <div class="ec-top">
        <div>
          <div class="ec-signal" id="ec-signal" style="color:var(--t3)">SCANNING FOR ELITE SETUP‚Ä¶</div>
          <div class="ec-sub" id="ec-sub">Requires 4+ confirmations ¬∑ 95%+ probability</div>
        </div>
        <div class="ec-dir" id="ec-dir" style="color:var(--t3)">‚Äî</div>
      </div>
      <!-- Probability Meter -->
      <div class="prob-section">
        <div class="prob-label">
          <span class="prob-lbl">WEIGHTED PROBABILITY SCORE</span>
          <span class="prob-pct" id="prob-pct" style="color:var(--t3)">0%</span>
        </div>
        <div class="prob-bar">
          <div class="prob-fill" id="prob-fill" style="width:0%;background:var(--border3)"></div>
          <div class="threshold-line"></div>
          <div class="threshold-tag">95%</div>
        </div>
        <div class="prob-tier" id="prob-tier" style="color:var(--t3)">STANDBY ‚Äî WAITING FOR CONFLUENCE</div>
      </div>
    </div>

    <!-- Confluence Grid -->
    <div style="margin:0 8px 2px;font-size:7px;color:var(--t3);letter-spacing:.08em">CONFIRMATION CHECKLIST (4+ REQUIRED)</div>
    <div class="conf-grid" id="conf-grid"></div>

    <!-- Entry Levels -->
    <div class="levels-block">
      <div class="levels-hdr"><span>TRADE PARAMETERS</span><span id="lv-rr" style="color:var(--gold)">‚Äî</span></div>
      <div class="lrow"><span class="ll">ENTRY ZONE</span><span class="lv" id="lv-ent">‚Äî</span></div>
      <div class="lrow"><span class="ll">STOP LOSS</span><span class="lv" id="lv-sl" style="color:var(--crimson)">‚Äî</span></div>
      <div class="lrow"><span class="ll">TARGET 1</span><span class="lv" id="lv-tp1" style="color:var(--jade)">‚Äî</span></div>
      <div class="lrow"><span class="ll">TARGET 2</span><span class="lv" id="lv-tp2" style="color:var(--jade2)">‚Äî</span></div>
      <div class="lrow"><span class="ll">PROJ MOVE</span><span class="lv" id="lv-move">‚Äî</span></div>
    </div>

    <!-- OI Block -->
    <div class="oi-block">
      <div style="font-size:7px;color:var(--t3);letter-spacing:.07em;margin-bottom:5px">OI PRESSURE DYNAMICS</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <div style="font-size:7px;color:var(--t3)">LONG PRESSURE</div>
          <div class="mini-bar"><div id="lp-fill" class="mini-fill" style="background:var(--jade);width:50%"></div></div>
          <div class="dual-row"><span id="lp-pct">50%</span></div>
        </div>
        <div>
          <div style="font-size:7px;color:var(--t3)">SHORT PRESSURE</div>
          <div class="mini-bar"><div id="sp-fill" class="mini-fill" style="background:var(--crimson);width:50%"></div></div>
          <div class="dual-row"><span id="sp-pct">50%</span></div>
        </div>
      </div>
      <div style="margin-top:5px;padding-top:5px;border-top:1px solid var(--border);font-size:7px;color:var(--t3)">
        OI EVENT: <span id="oi-event" style="color:var(--t2)">‚Äî</span>
      </div>
      <div style="font-size:7px;color:var(--t3);margin-top:2px">
        FUNDING: <span id="fund-state" style="color:var(--t2)">‚Äî</span>
      </div>
    </div>

    <!-- Events -->
    <div class="elog">
      <div class="block-hdr">SMART MONEY EVENTS</div>
      <div id="elog-list"></div>
    </div>

    <div class="disc">‚ö† STRICTLY EDUCATIONAL ‚Äî This system does not guarantee profits. Cryptocurrency trading involves extreme risk. All signals are for learning purposes only. 95% confidence ‚â† guaranteed outcome. Never risk more than you can afford to lose.</div>
  </div>

  <!-- MTF PANE -->
  <div id="pane-mtf" class="pane">
    <div style="padding:6px 8px;font-size:7px;color:var(--t3);letter-spacing:.07em">MULTI-TIMEFRAME ANALYSIS</div>
    <div class="mtf-block">
      <div class="block-hdr">4H MACRO BIAS (EMA 9/21/45)</div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--gold)">4H</div>
        <div class="mtf-detail" id="mtf-4h-detail">Loading‚Ä¶</div>
        <div class="tag neu" id="mtf-4h-tag">‚Äî</div>
      </div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--gold);font-size:7px">EMA</div>
        <div class="mtf-detail" id="mtf-4h-ema">9:‚Äî 21:‚Äî 45:‚Äî</div>
        <div></div>
      </div>
    </div>
    <div class="mtf-block">
      <div class="block-hdr">1H INTERMEDIATE BIAS (EMA 200)</div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--sky)">1H</div>
        <div class="mtf-detail" id="mtf-1h-detail">Loading‚Ä¶</div>
        <div class="tag neu" id="mtf-1h-tag">‚Äî</div>
      </div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--sky);font-size:7px">E200</div>
        <div class="mtf-detail" id="mtf-1h-ema">EMA200: ‚Äî</div>
        <div></div>
      </div>
    </div>
    <div class="mtf-block">
      <div class="block-hdr">15M EXECUTION LAYER</div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--jade)">15M</div>
        <div class="mtf-detail" id="mtf-15m-detail">EMA20/50 ¬∑ VWAP ¬∑ RSI</div>
        <div class="tag neu" id="mtf-15m-tag">‚Äî</div>
      </div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--jade);font-size:7px">RSI</div>
        <div class="mtf-detail" id="mtf-15m-rsi">RSI(14): ‚Äî | VWAP: ‚Äî</div>
        <div></div>
      </div>
    </div>
    <div class="mtf-block">
      <div class="block-hdr">VOLATILITY & ATR STATE</div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--amber);font-size:7px">ATR</div>
        <div class="mtf-detail" id="mtf-atr">ATR(14): ‚Äî</div>
        <div class="tag neu" id="mtf-atr-tag">‚Äî</div>
      </div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--violet);font-size:7px">VOL</div>
        <div class="mtf-detail" id="mtf-vol">Volume Ratio: ‚Äî</div>
        <div class="tag neu" id="mtf-vol-tag">‚Äî</div>
      </div>
      <div class="mtf-row">
        <div class="mtf-tf" style="color:var(--crimson);font-size:7px">WS</div>
        <div class="mtf-detail" id="mtf-ws">Whipsaw: ‚Äî</div>
        <div class="tag neu" id="mtf-ws-tag">‚Äî</div>
      </div>
    </div>
    <div class="mtf-block">
      <div class="block-hdr">WEIGHTED SCORING BREAKDOWN</div>
      <div id="score-breakdown" style="padding:4px 0;"></div>
    </div>
  </div>

  <!-- SIGNALS PANE -->
  <div id="pane-sigs" class="pane">
    <div style="padding:6px 8px;font-size:7px;color:var(--t3);letter-spacing:.07em">LIVE SIGNAL OUTPUT (95%+ ONLY)</div>
    <div id="sig-list"></div>
  </div>

  <!-- BACKTEST PANE -->
  <div id="pane-bt" class="pane">
    <div style="padding:6px 8px;font-size:7px;color:var(--t3);letter-spacing:.07em">ELITE BACKTESTING ENGINE + MONTE CARLO</div>
    <div class="bt-sel-row">
      <select class="bt-sel" id="bt-period">
        <option value="800">~12 Months</option>
        <option value="500">~6 Months</option>
        <option value="250">~3 Months</option>
      </select>
      <button class="elite-btn btn-gold" onclick="runBacktest()">‚ñ∂ RUN ENGINE</button>
    </div>
    <div id="bt-status" style="padding:0 8px 4px;font-size:8px;color:var(--gold);display:none"></div>
    <div class="bt-metrics" id="bt-metrics" style="display:none"></div>
    <canvas id="bt-eq" width="276" height="90" style="display:none;margin:0 8px 6px;border:1px solid var(--border);border-radius:4px;"></canvas>
    <div class="monte-block" id="monte-block" style="display:none">
      <div class="monte-title">MONTE CARLO VALIDATION (500 SIMULATIONS)</div>
      <div id="monte-rows"></div>
    </div>
    <div id="bt-gate" style="display:none;margin:0 8px 6px;padding:8px;border-radius:5px;font-size:8px;line-height:1.7;"></div>
    <div id="bt-log" style="display:none;padding:0 8px;font-size:8px;color:var(--t2);max-height:150px;overflow-y:auto;"></div>
  </div>

  <!-- HISTORY PANE -->
  <div id="pane-hist" class="pane">
    <div style="padding:6px 8px;font-size:7px;color:var(--t3);letter-spacing:.07em">SIGNAL HISTORY DATABASE</div>
    <div class="exp-row">
      <div class="exp-btn" onclick="exportCSV()">‚¨á CSV</div>
      <div class="exp-btn" onclick="exportJSON_()">‚¨á JSON</div>
      <div class="exp-btn" onclick="clearHist()">‚úï CLEAR</div>
    </div>
    <div class="htable">
      <div class="hthdr"><span>TIME</span><span>PAIR</span><span>DIR</span><span>CONF</span><span>STATUS</span></div>
      <div id="hist-list"></div>
    </div>
  </div>

  <!-- TELEGRAM PANE -->
  <div id="pane-tg" class="pane">
    <div class="tg-section">
      <div class="tg-info-box">
        <span style="color:var(--gold);font-weight:700">‚ö° ALL 5 COINS MONITORED</span><br>
        Background scanner runs every <b style="color:var(--t0)">90 seconds</b> checking<br>
        <b style="color:var(--t0)">ETH ¬∑ BTC ¬∑ SOL ¬∑ BNB ¬∑ XRP</b> simultaneously.<br>
        Alerts fire ONLY when score ‚â•95% + 4+ confirmations.
      </div>
      <div id="scan-badge">Scanner initializing‚Ä¶</div>
      <input class="tg-input" id="tg-token" placeholder="Bot Token: 123456:ABCdef‚Ä¶" type="password"/>
      <input class="tg-input" id="tg-chat" placeholder="Chat ID: -100123456789"/>
      <div class="tg-toggle-row">
        <input type="checkbox" id="tg-enable" style="width:13px;height:13px;accent-color:var(--jade)"/>
        <span class="toggle-label">Enable live alerts for all 5 coins</span>
      </div>
      <div class="tg-btns">
        <button class="elite-btn btn-sky" onclick="testTelegram()" style="flex:1;font-size:8px">‚úì TEST</button>
        <button class="elite-btn btn-gold" onclick="saveTgConfig()" style="flex:1;font-size:8px">üíæ SAVE</button>
      </div>
      <div id="tg-status"></div>
      <div style="margin-top:8px;font-size:7px;color:var(--t3);line-height:1.8;border:1px solid var(--border);border-radius:4px;padding:8px">
        <b style="color:var(--sky)">RENDER DEPLOY:</b><br>
        1. Rename file ‚Üí index.html<br>
        2. Push to GitHub repo<br>
        3. Render.com ‚Üí New Static Site ‚Üí connect repo<br>
        4. Publish dir: <code>.</code> ‚Üí Deploy<br>
        5. Enter token + Chat ID ‚Üí Save ‚Üí Enable alerts<br>
        Your live URL runs 24/7 ‚Äî no backend needed
      </div>
    </div>
  </div>

  <!-- JSON PANE -->
  <div id="pane-json" class="pane">
    <div style="padding:6px 8px;font-size:7px;color:var(--t3);letter-spacing:.07em">STRUCTURED JSON OUTPUT (LIVE)</div>
    <pre id="json-out">Waiting for analysis‚Ä¶</pre>
  </div>
</div>

<!-- CHART AREA -->
<div id="chart-area">
  <div id="chart-hdr">
    <div class="ch-item"><span class="ch-lbl">PAIR</span><span class="ch-v" id="ch-pair" style="color:var(--gold)">‚Äî</span></div>
    <div class="ch-item"><span class="ch-lbl">OI DELTA</span><span class="ch-v" id="ch-oid">‚Äî</span></div>
    <div class="ch-item"><span class="ch-lbl">VOL RATIO</span><span class="ch-v" id="ch-vr">‚Äî</span></div>
    <div class="ch-item"><span class="ch-lbl">ATR</span><span class="ch-v" id="ch-atr">‚Äî</span></div>
    <div class="ch-item"><span class="ch-lbl">BRK PROB</span><span class="ch-v" id="ch-bp">‚Äî</span></div>
    <div class="ch-item"><span class="ch-lbl">RSI(14)</span><span class="ch-v" id="ch-rsi">‚Äî</span></div>
    <div class="ch-item" style="margin-left:auto"><span class="ch-lbl">SCORE</span><span class="ch-v" id="ch-score" style="font-family:var(--orb);font-weight:700">‚Äî</span></div>
  </div>
  <div id="cw"><canvas id="mc"></canvas></div>
  <div class="sub-panel" id="oi-pnl"><canvas class="sub-canvas" id="oic"></canvas><span class="sub-lbl">OI DELTA</span></div>
  <div class="sub-panel" id="vol-pnl"><canvas class="sub-canvas" id="vc"></canvas><span class="sub-lbl">TAKER VOLUME</span></div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GURU MASTER PRO ‚Äî OI FLOW ELITE ENGINE
//  95%+ Confidence Only ¬∑ 4+ Confirmations Required
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FAPI='https://fapi.binance.com';

const G={
  sym:'ETHUSDT',dec:2,
  c15:[],c1h:[],c4h:[],
  oiHist:[],funding:0,currentOI:0,
  price:0,chg24:0,vol24:0,
  analysis:null,history:[],
  tg:{token:'',chat:'',enabled:false},
  lastAlert:{},activeTab:'dash',
  btResult:null,liveMode:false,
};

// ‚ïê‚ïê‚ïê INDICATORS ‚ïê‚ïê‚ïê
function ema(arr,p){
  const k=2/(p+1),r=[];
  arr.forEach((v,i)=>{
    if(i<p-1){r.push(null);return;}
    if(i===p-1){r.push(arr.slice(0,p).reduce((a,b)=>a+b,0)/p);return;}
    r.push(v*k+r[i-1]*(1-k));
  });
  return r;
}
function atr14(c){
  const tr=c.map((x,i)=>{if(!i)return x.h-x.l;const p=c[i-1].c;return Math.max(x.h-x.l,Math.abs(x.h-p),Math.abs(x.l-p));});
  const r=new Array(c.length).fill(null);
  if(tr.length<14)return r;
  r[13]=tr.slice(0,14).reduce((a,b)=>a+b,0)/14;
  for(let i=14;i<tr.length;i++)r[i]=(r[i-1]*13+tr[i])/14;
  return r;
}
function rsi14(cl){
  const r=new Array(cl.length).fill(null);
  if(cl.length<15)return r;
  let ag=0,al=0;
  for(let i=1;i<=14;i++){const d=cl[i]-cl[i-1];if(d>0)ag+=d;else al-=d;}
  ag/=14;al/=14;
  r[14]=al===0?100:100-100/(1+ag/al);
  for(let i=15;i<cl.length;i++){
    const d=cl[i]-cl[i-1];
    ag=(ag*13+(d>0?d:0))/14;
    al=(al*13+(d<0?-d:0))/14;
    r[i]=al===0?100:100-100/(1+ag/al);
  }
  return r;
}
function vwap(c){let cv=0,cq=0;return c.map(x=>{const tp=(x.h+x.l+x.c)/3;cv+=tp*x.v;cq+=x.v;return cq?cv/cq:x.c;});}
function sma(arr,p){return arr.map((v,i)=>i<p-1?null:arr.slice(i-p+1,i+1).reduce((a,b)=>a+b,0)/p);}
function bbands(cl,p=20,m=2){
  const em=ema(cl,p);
  return cl.map((c,i)=>{
    if(!em[i])return null;
    const sl=cl.slice(Math.max(0,i-p+1),i+1);
    const mn=sl.reduce((a,b)=>a+b,0)/sl.length;
    const std=Math.sqrt(sl.reduce((a,b)=>a+(b-mn)**2,0)/sl.length);
    return{mid:em[i],up:em[i]+m*std,dn:em[i]-m*std,bw:2*m*std/(em[i]||1)};
  });
}
const fmt=(n,d=2)=>n==null?'‚Äî':Number(n).toFixed(d);
const fmtK=n=>{const a=Math.abs(n);return a>1e9?(n/1e9).toFixed(2)+'B':a>1e6?(n/1e6).toFixed(2)+'M':a>1e3?(n/1e3).toFixed(1)+'K':n.toFixed(0);}

// ‚ïê‚ïê‚ïê FETCH ‚ïê‚ïê‚ïê
async function apiFetch(url){
  try{const r=await fetch(url);if(!r.ok)throw 0;return await r.json();}
  catch{return null;}
}
function setLoad(msg,pct){
  document.getElementById('lstat').textContent=msg;
  document.getElementById('lbar').style.width=pct+'%';
}
async function loadAll(){
  setLoad('Fetching 15M candles‚Ä¶',10);
  const k15=await apiFetch(`${FAPI}/fapi/v1/klines?symbol=${G.sym}&interval=15m&limit=200`);
  if(k15)G.c15=k15.map(pk);
  setLoad('Fetching 1H candles‚Ä¶',25);
  const k1h=await apiFetch(`${FAPI}/fapi/v1/klines?symbol=${G.sym}&interval=1h&limit=220`);
  if(k1h)G.c1h=k1h.map(pk);
  setLoad('Fetching 4H candles‚Ä¶',40);
  const k4h=await apiFetch(`${FAPI}/fapi/v1/klines?symbol=${G.sym}&interval=4h&limit=100`);
  if(k4h)G.c4h=k4h.map(pk);
  setLoad('Fetching open interest history‚Ä¶',55);
  const oi=await apiFetch(`${FAPI}/futures/data/openInterestHist?symbol=${G.sym}&period=15m&limit=200`);
  if(oi)G.oiHist=oi.map(o=>({t:+o.timestamp,oi:+o.sumOpenInterest}));
  setLoad('Fetching funding rate‚Ä¶',70);
  const fr=await apiFetch(`${FAPI}/fapi/v1/fundingRate?symbol=${G.sym}&limit=5`);
  if(fr&&fr.length)G.funding=+fr[fr.length-1].fundingRate;
  setLoad('Fetching ticker‚Ä¶',85);
  const tk=await apiFetch(`${FAPI}/fapi/v1/ticker/24hr?symbol=${G.sym}`);
  if(tk){G.price=+tk.lastPrice;G.chg24=+tk.priceChangePercent;G.vol24=+tk.quoteVolume;}
  const oin=await apiFetch(`${FAPI}/fapi/v1/openInterest?symbol=${G.sym}`);
  if(oin)G.currentOI=+oin.openInterest;
  G.dec=G.sym.includes('BTC')?1:G.sym.includes('XRP')?4:G.sym.includes('BNB')?3:2;
  setLoad('Computing elite analysis‚Ä¶',95);
  compute();
  setLoad('Ready.',100);
  setTimeout(()=>{document.getElementById('lov').style.display='none';},300);
  renderAll();
  startCountdowns();
}
async function refreshQuick(){
  const tk=await apiFetch(`${FAPI}/fapi/v1/ticker/price?symbol=${G.sym}`);
  if(tk)G.price=+tk.price;
  const kl=await apiFetch(`${FAPI}/fapi/v1/klines?symbol=${G.sym}&interval=15m&limit=3`);
  if(kl&&G.c15.length)G.c15[G.c15.length-1]=pk(kl[kl.length-1]);
  compute();renderAll();
}
function pk(k){return{t:+k[0],o:+k[1],h:+k[2],l:+k[3],c:+k[4],v:+k[5],qv:+k[7],tqv:+k[9]};}

// ‚ïê‚ïê‚ïê COUNTDOWN ‚ïê‚ïê‚ïê
function startCountdowns(){
  if(G._cdt)clearInterval(G._cdt);
  G._cdt=setInterval(()=>{
    const now=Date.now();
    const f=ms=>{const m=Math.floor(ms/60000),s=Math.floor(ms%60000/1000);return`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;};
    document.getElementById('cd-15m').textContent=f(900000-(now%900000));
    document.getElementById('cd-1h').textContent=f(3600000-(now%3600000));
    document.getElementById('cd-4h').textContent=f(14400000-(now%14400000));
  },1000);
}

// ‚ïê‚ïê‚ïê CORE ANALYSIS ENGINE ‚ïê‚ïê‚ïê
function compute(){
  if(G.c15.length<55)return;
  const N=G.c15.length-1;
  const last=G.c15[N],prev=G.c15[N-1]||last;
  const cl15=G.c15.map(c=>c.c);
  const hi15=G.c15.map(c=>c.h),lo15=G.c15.map(c=>c.l);

  // ‚îÄ‚îÄ 4H EMA 9/21/45 ‚îÄ‚îÄ
  const cl4h=G.c4h.map(c=>c.c);
  const n4=G.c4h.length-1;
  const e9_4h=ema(cl4h,9),e21_4h=ema(cl4h,21),e45_4h=ema(cl4h,45);
  const v9=e9_4h[n4],v21=e21_4h[n4],v45=e45_4h[n4],p4=G.c4h[n4]?.c||0;
  let bias4h='NEU';
  if(v9&&v21&&v45){
    if(v9>v21&&v21>v45&&p4>v21)bias4h='BULL';
    else if(v9<v21&&v21<v45&&p4<v21)bias4h='BEAR';
  }

  // ‚îÄ‚îÄ 1H EMA 200 ‚îÄ‚îÄ
  const cl1h=G.c1h.map(c=>c.c);
  const n1=G.c1h.length-1;
  const e200=ema(cl1h,200);
  const v200=e200[n1],p1=G.c1h[n1]?.c||0;
  let bias1h='NEU';
  if(v200)bias1h=p1>v200?'BULL':'BEAR';

  // ‚îÄ‚îÄ 15M INDICATORS ‚îÄ‚îÄ
  const e20=ema(cl15,20),e50=ema(cl15,50);
  const vwapLine=vwap(G.c15);
  const rsiLine=rsi14(cl15);
  const atrLine=atr14(G.c15);
  const bbLine=bbands(cl15,20,2);
  const e20v=e20[N],e50v=e50[N];
  const vwapV=vwapLine[N];
  const rsiV=rsiLine[N];
  const atrV=atrLine[N]||(last.h-last.l);
  const bbV=bbLine[N];

  // ‚îÄ‚îÄ OI ‚îÄ‚îÄ
  const matchOI=G.c15.map(c=>G.oiHist.find(o=>Math.abs(o.t-c.t)<900000)?.oi||null);
  const oiDeltas=matchOI.map((o,i)=>(!i||!o||!matchOI[i-1])?0:o-matchOI[i-1]);
  const oiDelta=oiDeltas[N]||0;
  const priceUp=last.c>prev.c,priceDown=last.c<prev.c;
  let oiPattern='NEUTRAL';
  if(priceUp&&oiDelta>0)oiPattern='AGG_LONG';
  else if(priceDown&&oiDelta>0)oiPattern='AGG_SHORT';
  else if(priceUp&&oiDelta<0)oiPattern='SHORT_SQUEEZE';
  else if(priceDown&&oiDelta<0)oiPattern='LONG_LIQ';
  const maxOID=Math.max(...oiDeltas.slice(-20).map(Math.abs),1);
  const oiStr=Math.min(100,Math.abs(oiDelta)/maxOID*100);

  // ‚îÄ‚îÄ VOLUME ‚îÄ‚îÄ
  const vols=G.c15.map(c=>c.v);
  const avgVol=vols.slice(-20).reduce((a,b)=>a+b,0)/20||1;
  const volRatio=vols[N]/avgVol;
  const volSpike=volRatio>1.8;
  const tqv=G.c15[N].tqv||0,qv=G.c15[N].qv||1;
  const takerR=tqv/qv;
  const buyPres=takerR>0.55,sellPres=takerR<0.45;
  const r5buy=G.c15.slice(-5).reduce((a,c)=>a+c.tqv,0);
  const r5tot=G.c15.slice(-5).reduce((a,c)=>a+c.qv,0)||1;
  const netIn=r5buy/r5tot;

  // ‚îÄ‚îÄ RANGE / BB ‚îÄ‚îÄ
  const rHigh=Math.max(...hi15.slice(-10));
  const rLow=Math.min(...lo15.slice(-10));
  const rSz=rHigh-rLow||1;
  const avgR5=G.c15.slice(-5).reduce((a,c)=>a+(c.h-c.l),0)/5||1;
  const avgR20=G.c15.slice(-20).reduce((a,c)=>a+(c.h-c.l),0)/20||1;
  const compression=avgR5/avgR20;
  const bbWs=bbLine.slice(-10).filter(Boolean).map(b=>b.bw);
  const bbAvg=bbWs.length?bbWs.reduce((a,b)=>a+b,0)/bbWs.length:0.01;
  const bbComp=bbV&&bbV.bw<bbAvg*0.65;
  const isComp=(compression<0.60||bbComp);

  // ‚îÄ‚îÄ WHIPSAW ‚îÄ‚îÄ
  const dojiN=G.c15.slice(-4).filter(c=>{const b=Math.abs(c.c-c.o),r=c.h-c.l;return r>atrV*0.8&&b<r*0.3;}).length;
  const vwapComp=Math.abs(last.c-vwapV)/(vwapV||1)<0.001;
  const lowAtr=atrV<avgR20*0.45;
  const emaSpreadTight=e20v&&e50v&&Math.abs(e20v-e50v)/(e20v||1)<0.003;
  const whipsaw=dojiN>=2||(emaSpreadTight&&vwapComp&&lowAtr);

  // ‚îÄ‚îÄ BREAKOUT PROB ‚îÄ‚îÄ
  let brkProb=35;
  if(isComp||bbComp)brkProb+=20;
  if(volSpike)brkProb+=18;
  if(oiStr>50)brkProb+=15;
  if(Math.abs(G.funding)>0.0003)brkProb+=8;
  brkProb=Math.min(94,brkProb);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  WEIGHTED CONFLUENCE SCORING ENGINE
  //  Weighted probability score ‚Äî MUST hit 95
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const WEIGHTS={
    tf4h_bull:18,tf4h_bear:18,    // 4H macro bias
    tf1h_bull:14,tf1h_bear:14,    // 1H intermediate
    ema_pull_bull:10,ema_pull_bear:10, // EMA 20/50 pullback
    vwap_bull:8,vwap_bear:8,      // VWAP reclaim/rejection
    rsi_bull:8,rsi_bear:8,        // RSI > 55 or < 45
    brk_bull:9,brk_bear:9,        // Break & retest
    sweep_bull:9,sweep_bear:9,    // 5-candle sweep
    delta_bull:7,delta_bear:7,    // Volume delta
    oi_squeeze:12,oi_liq:12,      // OI pattern
    oi_agglong:8,oi_aggshort:8,
    funding_bull:8,funding_bear:8, // Funding extremes
    vol_spike_bull:5,vol_spike_bear:5,
    atr_expansion:4,
  };

  let bullScore=0,bearScore=0;
  const bullConf=[],bearConf=[];
  const scoreBD=[];

  // ‚îÄ‚îÄ TF ALIGNMENT ‚îÄ‚îÄ
  const bull4h=(bias4h==='BULL');
  const bear4h=(bias4h==='BEAR');
  if(bull4h){bullScore+=WEIGHTS.tf4h_bull;bullConf.push({label:'4H Macro Bullish (EMA 9>21>45)',w:WEIGHTS.tf4h_bull,dir:'bull'});}
  if(bear4h){bearScore+=WEIGHTS.tf4h_bear;bearConf.push({label:'4H Macro Bearish (EMA 9<21<45)',w:WEIGHTS.tf4h_bear,dir:'bear'});}
  scoreBD.push({label:'4H EMA Alignment',bullVal:bull4h?WEIGHTS.tf4h_bull:0,bearVal:bear4h?WEIGHTS.tf4h_bear:0,max:WEIGHTS.tf4h_bull});

  const bull1h=(bias1h==='BULL');
  const bear1h=(bias1h==='BEAR');
  if(bull1h){bullScore+=WEIGHTS.tf1h_bull;bullConf.push({label:'1H EMA200 Bullish Dominance',w:WEIGHTS.tf1h_bull,dir:'bull'});}
  if(bear1h){bearScore+=WEIGHTS.tf1h_bear;bearConf.push({label:'1H EMA200 Bearish Dominance',w:WEIGHTS.tf1h_bear,dir:'bear'});}
  scoreBD.push({label:'1H EMA200 Position',bullVal:bull1h?WEIGHTS.tf1h_bull:0,bearVal:bear1h?WEIGHTS.tf1h_bear:0,max:WEIGHTS.tf1h_bull});

  // ‚îÄ‚îÄ 15M CONFIRMATIONS ‚îÄ‚îÄ
  // 1. EMA 20/50 pullback rejection
  const ema_bull_rej=e20v&&e50v&&last.c>e20v&&last.c>e50v&&last.l<=e20v*1.003;
  const ema_bear_rej=e20v&&e50v&&last.c<e20v&&last.c<e50v&&last.h>=e20v*0.997;
  if(ema_bull_rej){bullScore+=WEIGHTS.ema_pull_bull;bullConf.push({label:'EMA 20/50 Pullback Rejection',w:WEIGHTS.ema_pull_bull,dir:'bull'});}
  if(ema_bear_rej){bearScore+=WEIGHTS.ema_pull_bear;bearConf.push({label:'EMA 20/50 Rejection',w:WEIGHTS.ema_pull_bear,dir:'bear'});}
  scoreBD.push({label:'EMA 20/50 Pullback',bullVal:ema_bull_rej?WEIGHTS.ema_pull_bull:0,bearVal:ema_bear_rej?WEIGHTS.ema_pull_bear:0,max:WEIGHTS.ema_pull_bull});

  // 2. VWAP reclaim/rejection
  const vwap_bull=last.c>vwapV&&prev.c<=vwapV;
  const vwap_bear=last.c<vwapV&&prev.c>=vwapV;
  if(vwap_bull){bullScore+=WEIGHTS.vwap_bull;bullConf.push({label:'VWAP Reclaim',w:WEIGHTS.vwap_bull,dir:'bull'});}
  if(vwap_bear){bearScore+=WEIGHTS.vwap_bear;bearConf.push({label:'VWAP Rejection',w:WEIGHTS.vwap_bear,dir:'bear'});}
  scoreBD.push({label:'VWAP Reclaim/Rejection',bullVal:vwap_bull?WEIGHTS.vwap_bull:0,bearVal:vwap_bear?WEIGHTS.vwap_bear:0,max:WEIGHTS.vwap_bull});

  // 3. RSI momentum (>55 bull, <45 bear)
  const rsi_bull=rsiV&&rsiV>55&&rsiLine[N-1]<=55;
  const rsi_bear=rsiV&&rsiV<45&&rsiLine[N-1]>=45;
  // Also count persistent RSI position
  const rsi_bull_pos=rsiV&&rsiV>58;
  const rsi_bear_pos=rsiV&&rsiV<42;
  if(rsi_bull||rsi_bull_pos){bullScore+=WEIGHTS.rsi_bull;bullConf.push({label:`RSI(14) Bull ${rsi_bull?'Cross':'Hold'} (${fmt(rsiV,1)})`,w:WEIGHTS.rsi_bull,dir:'bull'});}
  if(rsi_bear||rsi_bear_pos){bearScore+=WEIGHTS.rsi_bear;bearConf.push({label:`RSI(14) Bear ${rsi_bear?'Cross':'Hold'} (${fmt(rsiV,1)})`,w:WEIGHTS.rsi_bear,dir:'bear'});}
  scoreBD.push({label:'RSI(14) Momentum',bullVal:(rsi_bull||rsi_bull_pos)?WEIGHTS.rsi_bull:0,bearVal:(rsi_bear||rsi_bear_pos)?WEIGHTS.rsi_bear:0,max:WEIGHTS.rsi_bull});

  // 4. Break & retest swing
  const swHi=Math.max(...hi15.slice(-7,-1)),swLo=Math.min(...lo15.slice(-7,-1));
  const brk_bull=last.c>swHi&&prev.c<=swHi;
  const brk_bear=last.c<swLo&&prev.c>=swLo;
  if(brk_bull){bullScore+=WEIGHTS.brk_bull;bullConf.push({label:'Break & Retest Swing High',w:WEIGHTS.brk_bull,dir:'bull'});}
  if(brk_bear){bearScore+=WEIGHTS.brk_bear;bearConf.push({label:'Break & Retest Swing Low',w:WEIGHTS.brk_bear,dir:'bear'});}
  scoreBD.push({label:'Break & Retest',bullVal:brk_bull?WEIGHTS.brk_bull:0,bearVal:brk_bear?WEIGHTS.brk_bear:0,max:WEIGHTS.brk_bull});

  // 5. 5-candle liquidity sweep reversal
  const sweep5Hi=Math.max(...hi15.slice(-6,-1));
  const sweep5Lo=Math.min(...lo15.slice(-6,-1));
  const sweep_bull=last.l<sweep5Lo&&last.c>sweep5Lo;
  const sweep_bear=last.h>sweep5Hi&&last.c<sweep5Hi;
  if(sweep_bull){bullScore+=WEIGHTS.sweep_bull;bullConf.push({label:'5-Candle Liquidity Sweep (Bull)',w:WEIGHTS.sweep_bull,dir:'bull'});}
  if(sweep_bear){bearScore+=WEIGHTS.sweep_bear;bearConf.push({label:'5-Candle Liquidity Sweep (Bear)',w:WEIGHTS.sweep_bear,dir:'bear'});}
  scoreBD.push({label:'Liquidity Sweep',bullVal:sweep_bull?WEIGHTS.sweep_bull:0,bearVal:sweep_bear?WEIGHTS.sweep_bear:0,max:WEIGHTS.sweep_bull});

  // 6. Strong delta volume imbalance
  if(buyPres&&netIn>0.58){bullScore+=WEIGHTS.delta_bull;bullConf.push({label:`Delta Volume Bull (${(takerR*100).toFixed(0)}% buy)`,w:WEIGHTS.delta_bull,dir:'bull'});}
  if(sellPres&&netIn<0.42){bearScore+=WEIGHTS.delta_bear;bearConf.push({label:`Delta Volume Bear (${(takerR*100).toFixed(0)}% sell)`,w:WEIGHTS.delta_bear,dir:'bear'});}
  scoreBD.push({label:'Delta Volume',bullVal:(buyPres&&netIn>0.58)?WEIGHTS.delta_bull:0,bearVal:(sellPres&&netIn<0.42)?WEIGHTS.delta_bear:0,max:WEIGHTS.delta_bull});

  // 7. OI-price agreement
  if(oiPattern==='SHORT_SQUEEZE'){bullScore+=WEIGHTS.oi_squeeze;bullConf.push({label:'OI: Short Squeeze Building',w:WEIGHTS.oi_squeeze,dir:'bull'});}
  if(oiPattern==='AGG_LONG'){bullScore+=WEIGHTS.oi_agglong;bullConf.push({label:'OI: Aggressive Long Build',w:WEIGHTS.oi_agglong,dir:'bull'});}
  if(oiPattern==='LONG_LIQ'){bearScore+=WEIGHTS.oi_liq;bearConf.push({label:'OI: Long Liquidation Cascade',w:WEIGHTS.oi_liq,dir:'bear'});}
  if(oiPattern==='AGG_SHORT'){bearScore+=WEIGHTS.oi_aggshort;bearConf.push({label:'OI: Aggressive Short Build',w:WEIGHTS.oi_aggshort,dir:'bear'});}
  scoreBD.push({label:'OI Pattern',bullVal:(['SHORT_SQUEEZE','AGG_LONG'].includes(oiPattern))?Math.max(WEIGHTS.oi_squeeze,WEIGHTS.oi_agglong):0,bearVal:(['LONG_LIQ','AGG_SHORT'].includes(oiPattern))?Math.max(WEIGHTS.oi_liq,WEIGHTS.oi_aggshort):0,max:WEIGHTS.oi_squeeze});

  // 8. Funding extremes
  if(G.funding<-0.0003){bullScore+=WEIGHTS.funding_bull;bullConf.push({label:`Funding Short Extreme (${(G.funding*100).toFixed(4)}%)`,w:WEIGHTS.funding_bull,dir:'bull'});}
  if(G.funding>0.0003){bearScore+=WEIGHTS.funding_bear;bearConf.push({label:`Funding Long Extreme (${(G.funding*100).toFixed(4)}%)`,w:WEIGHTS.funding_bear,dir:'bear'});}
  scoreBD.push({label:'Funding Extreme',bullVal:G.funding<-0.0003?WEIGHTS.funding_bull:0,bearVal:G.funding>0.0003?WEIGHTS.funding_bear:0,max:WEIGHTS.funding_bull});

  // 9. Volume spike
  if(volSpike&&buyPres){bullScore+=WEIGHTS.vol_spike_bull;bullConf.push({label:`Volume Spike ${volRatio.toFixed(1)}x (Bull)`,w:WEIGHTS.vol_spike_bull,dir:'bull'});}
  if(volSpike&&sellPres){bearScore+=WEIGHTS.vol_spike_bear;bearConf.push({label:`Volume Spike ${volRatio.toFixed(1)}x (Bear)`,w:WEIGHTS.vol_spike_bear,dir:'bear'});}
  scoreBD.push({label:'Volume Spike',bullVal:(volSpike&&buyPres)?WEIGHTS.vol_spike_bull:0,bearVal:(volSpike&&sellPres)?WEIGHTS.vol_spike_bear:0,max:WEIGHTS.vol_spike_bull});

  // 10. ATR expansion
  if(atrV>avgR20*1.4){bullScore+=WEIGHTS.atr_expansion/2;bearScore+=WEIGHTS.atr_expansion/2;}

  // ‚îÄ‚îÄ NORMALIZE TO 0‚Äì100 ‚îÄ‚îÄ
  const maxPossibleBull=Object.values(WEIGHTS).filter((_,i)=>i%2===0).reduce((a,b)=>a+b,0);
  const maxPossibleBear=Object.values(WEIGHTS).filter((_,i)=>i%2===1).reduce((a,b)=>a+b,0);
  const bullPct=Math.min(100,bullScore/maxPossibleBull*100*1.35);
  const bearPct=Math.min(100,bearScore/maxPossibleBear*100*1.35);

  // ‚îÄ‚îÄ DIRECTION & ELITE THRESHOLD ‚îÄ‚îÄ
  let dir='WAIT',score=0,sigClass='WAIT',cls='';
  const allConfs=bullConf.length>bearConf.length?bullConf:bearConf;
  const confCount=bullConf.length>bearConf.length?bullConf.length:bearConf.length;

  if(!whipsaw){
    if(bullPct>bearPct&&bullPct>=70){
      dir='LONG';score=Math.round(bullPct);
      // Require 4+ confirmations for any signal
      if(bullConf.length<4)score=Math.min(score,89); // cap below 95 if <4 confs
      const fullAlign=bias4h==='BULL'&&bias1h==='BULL'&&bullConf.length>=4;
      sigClass=fullAlign&&score>=95?'ELITE STRONG BUY':score>=80?'EARLY BUY':'BUILDING';
      cls=fullAlign?'üèÜ ELITE STRONG BUY ‚Äî Full Alignment':'üìà Bullish Confluence Building';
    } else if(bearPct>bullPct&&bearPct>=70){
      dir='SHORT';score=Math.round(bearPct);
      if(bearConf.length<4)score=Math.min(score,89);
      const fullAlign=bias4h==='BEAR'&&bias1h==='BEAR'&&bearConf.length>=4;
      sigClass=fullAlign&&score>=95?'ELITE STRONG SELL':score>=80?'EARLY SELL':'BUILDING';
      cls=fullAlign?'üèÜ ELITE STRONG SELL ‚Äî Full Alignment':'üìâ Bearish Confluence Building';
    }
  } else {
    dir='CAUTION';score=Math.max(10,Math.min(40,Math.max(bullPct,bearPct)));
    sigClass='WHIPSAW';cls='‚ö† WHIPSAW ‚Äî Filter Active';
  }

  if(dir==='WAIT'||score===0){
    score=Math.round(Math.max(bullPct,bearPct));
    cls='‚ßó WAITING FOR ELITE SETUP';
  }

  score=Math.min(99,Math.max(0,score));

  // ‚îÄ‚îÄ ENTRY/SL/TP ‚îÄ‚îÄ
  const entry=last.c;
  const atrBuf=atrV*0.35;
  let sl,tp1,tp2;
  if(dir==='LONG'){
    sl=Math.min(last.l,rLow)-atrBuf;
    tp1=entry+(entry-sl)*2;
    tp2=entry+(entry-sl)*3;
  } else if(dir==='SHORT'){
    sl=Math.max(last.h,rHigh)+atrBuf;
    tp1=entry-(sl-entry)*2;
    tp2=entry-(sl-entry)*3;
  } else {
    sl=entry-atrV;tp1=entry+atrV*2;tp2=entry+atrV*3;
  }
  const projPct=Math.abs(tp1-entry)/entry*100;

  // ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
  const evts=[];
  const oiMap={AGG_LONG:'Price‚Üë + OI‚Üë ‚Üí Aggressive Long Build-up',AGG_SHORT:'Price‚Üì + OI‚Üë ‚Üí Aggressive Short Build-up',SHORT_SQUEEZE:'Price‚Üë + OI‚Üì ‚Üí Short Squeeze Detected',LONG_LIQ:'Price‚Üì + OI‚Üì ‚Üí Long Liquidation Cascade'};
  if(oiPattern!=='NEUTRAL')evts.push({c:'#f5c842',t:oiMap[oiPattern]});
  if(G.funding>0.0003)evts.push({c:'#ff2d55',t:`Funding +${(G.funding*100).toFixed(4)}% ‚Üí Long crowding risk`});
  if(G.funding<-0.0003)evts.push({c:'#00e5a0',t:`Funding ${(G.funding*100).toFixed(4)}% ‚Üí Short squeeze risk`});
  if(volSpike)evts.push({c:'#38bdf8',t:`Volume spike ${volRatio.toFixed(1)}x ‚Üí Abnormal flow`});
  if(isComp||bbComp)evts.push({c:'#fb923c',t:`Range compression ${(compression*100).toFixed(0)}% ‚Üí Breakout likely`});
  if(whipsaw)evts.push({c:'#fb923c',t:'Whipsaw filter ACTIVE ‚Äî Skipping signal'});

  // ‚îÄ‚îÄ OI PRESSURE RATIOS ‚îÄ‚îÄ
  const tot=bullScore+bearScore||1;
  const longPres=Math.round(bullScore/tot*100);

  // ‚îÄ‚îÄ SAVE TO HISTORY / ALERT ‚îÄ‚îÄ
  const isElite=sigClass==='ELITE STRONG BUY'||sigClass==='ELITE STRONG SELL';
  const symCool=G.lastAlert[G.sym]||0;
  if(isElite&&score>=95&&confCount>=4&&Date.now()-symCool>300000){
    G.lastAlert[G.sym]=Date.now();
    const rec={time:new Date().toLocaleTimeString(),sym:G.sym,cls,sigClass,dir,score,
      entry,sl,tp1,tp2,oiPattern,bias4h,bias1h,funding:G.funding,
      confCount,status:'ELITE',id:Date.now()};
    G.history.unshift(rec);
    if(G.history.length>100)G.history.pop();
    if(G.tg.enabled)sendTelegram(rec,G.sym,G.dec);
  }

  G.analysis={
    dir,score,sigClass,cls,entry,sl,tp1,tp2,projPct,
    oiPattern,oiStr,oiDelta,longPres,
    bullConf,bearConf,scoreBD,confCount,
    bias4h,bias1h,whipsaw,isComp,brkProb,
    volRatio,volSpike,takerR,
    atrV,atrLine,
    rsiV,vwapV,e20v,e50v,
    rHigh,rLow,
    evts,oiDeltas,vwapLine,e20,e50,bbLine,
    isElite,
    v9,v21,v45,v200,p4,p1,
  };
}
</script>
<script>

// ‚ïê‚ïê‚ïê CHART RENDERER ‚ïê‚ïê‚ïê
function drawChart(){
  const cv=document.getElementById('mc'),wrap=document.getElementById('cw');
  cv.width=wrap.clientWidth;cv.height=wrap.clientHeight;
  const ctx=cv.getContext('2d'),W=cv.width,H=cv.height;
  if(W<50||H<50)return;
  const a=G.analysis;if(!G.c15.length)return;
  const PT=22,PB=28,PL=6,PCOL=82;
  const PFRAC=0.33;
  const chartW=W-PL-PCOL;
  const projW=Math.floor(chartW*PFRAC);
  const candW=chartW-projW;
  const chartH=H-PT-PB;
  const projX0=PL+candW,projX1=PL+chartW;
  const VIS=Math.min(32,G.c15.length);
  const cands=G.c15.slice(-VIS);
  const xP=candW/VIS;
  const toX=i=>PL+i*xP+xP*.5;
  let pH=Math.max(...cands.map(c=>c.h)),pL=Math.min(...cands.map(c=>c.l));
  const raw=pH-pL||1;
  if(a&&a.dir==='LONG'){pH=Math.max(pH,a.tp2)+raw*.04;pL=Math.min(pL,a.sl)-raw*.04;}
  else if(a&&a.dir==='SHORT'){pH=Math.max(pH,a.sl)+raw*.04;pL=Math.min(pL,a.tp2)-raw*.04;}
  else{pH+=raw*.07;pL-=raw*.07;}
  const pR=pH-pL||1;
  const toY=p=>PT+chartH-((p-pL)/pR)*chartH;
  const cY=y=>Math.max(PT,Math.min(PT+chartH,y));

  // Background
  ctx.fillStyle='#04060d';ctx.fillRect(0,0,W,H);

  // Grid
  ctx.strokeStyle='rgba(12,18,32,.95)';ctx.lineWidth=.4;
  for(let i=0;i<=8;i++){const y=PT+(chartH/8)*i;ctx.beginPath();ctx.moveTo(PL,y);ctx.lineTo(projX0,y);ctx.stroke();}
  for(let i=0;i<VIS;i+=5){const x=toX(i);ctx.beginPath();ctx.moveTo(x,PT);ctx.lineTo(x,PT+chartH);ctx.stroke();}

  // Projection bg ‚Äî obsidian with gold tint
  const pbg=ctx.createLinearGradient(projX0,0,projX1,0);
  pbg.addColorStop(0,'rgba(6,10,18,.97)');
  pbg.addColorStop(1,'rgba(8,12,22,.93)');
  ctx.fillStyle=pbg;ctx.fillRect(projX0,PT,projW,chartH);
  ctx.strokeStyle='rgba(245,200,66,.06)';ctx.lineWidth=.8;ctx.setLineDash([3,3]);
  ctx.beginPath();ctx.moveTo(projX0,PT);ctx.lineTo(projX0,PT+chartH);ctx.stroke();
  ctx.setLineDash([]);

  // Price scale bg
  ctx.fillStyle='#060a14';ctx.fillRect(projX1,0,PCOL,H);
  ctx.strokeStyle='rgba(28,45,69,.9)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(projX1,0);ctx.lineTo(projX1,H);ctx.stroke();

  // ‚îÄ‚îÄ PROJECTION ZONES ‚îÄ‚îÄ
  if(a&&(a.dir==='LONG'||a.dir==='SHORT')&&a.score>=60){
    ctx.save();
    ctx.beginPath();ctx.rect(projX0,PT,projW,chartH);ctx.clip();
    const isL=a.dir==='LONG';
    const ey=cY(toY(a.entry)),sy=cY(toY(a.sl));
    const t1y=cY(toY(a.tp1)),t2y=cY(toY(a.tp2));
    const pW=projW,alpha=Math.min(.9,a.score/100);

    // SL zone (red)
    const rt=Math.min(ey,sy),rb=Math.max(ey,sy);
    ctx.fillStyle=`rgba(150,10,30,${alpha*.4})`;ctx.fillRect(projX0,rt,pW,rb-rt);
    ctx.strokeStyle=`rgba(255,45,85,${alpha*.8})`;ctx.lineWidth=1.5;ctx.strokeRect(projX0,rt,pW,rb-rt);

    // SL marker square (like reference image)
    ctx.fillStyle='rgba(255,45,85,.95)';
    ctx.fillRect(projX0-5,sy-5,10,10);

    // TP1 zone (gold-green gradient ‚Äî elite style)
    const p1t=Math.min(ey,t1y),p1b=Math.max(ey,t1y);
    const gc=ctx.createLinearGradient(projX0,p1t,projX0,p1b);
    if(isL){gc.addColorStop(0,`rgba(0,190,100,${alpha*.5})`);gc.addColorStop(.5,`rgba(245,200,66,${alpha*.15})`);gc.addColorStop(1,`rgba(0,130,70,${alpha*.2})`);}
    else{gc.addColorStop(0,`rgba(0,130,70,${alpha*.2})`);gc.addColorStop(.5,`rgba(245,200,66,${alpha*.15})`);gc.addColorStop(1,`rgba(0,190,100,${alpha*.5})`);}
    ctx.fillStyle=gc;ctx.fillRect(projX0,p1t,pW,p1b-p1t);
    ctx.strokeStyle=`rgba(0,229,160,${alpha*.85})`;ctx.lineWidth=1.5;ctx.strokeRect(projX0,p1t,pW,p1b-p1t);

    // TP2 zone
    const p2t=Math.min(t1y,t2y),p2b=Math.max(t1y,t2y);
    ctx.fillStyle=`rgba(0,160,80,${alpha*.2})`;ctx.fillRect(projX0,p2t,pW,p2b-p2t);
    ctx.strokeStyle=`rgba(0,229,160,${alpha*.3})`;ctx.lineWidth=.7;ctx.strokeRect(projX0,p2t,pW,p2b-p2t);

    // Gold dot at entry
    ctx.fillStyle=a.score>=95?'rgba(245,200,66,.95)':'rgba(0,229,160,.85)';
    ctx.beginPath();ctx.arc(projX0+4,ey,4,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.3)';ctx.lineWidth=1;ctx.stroke();

    // Curved projection path (glow)
    ctx.save();
    ctx.shadowBlur=12;ctx.shadowColor=isL?'#00e5a0':'#ff2d55';
    ctx.strokeStyle=isL?'rgba(0,229,160,.95)':'rgba(255,45,85,.95)';
    ctx.lineWidth=2;ctx.setLineDash([7,4]);
    ctx.beginPath();ctx.moveTo(projX0,ey);
    ctx.bezierCurveTo(projX0+pW*.3,ey,projX0+pW*.65,t1y,projX0+pW*.9,t1y);
    ctx.stroke();ctx.setLineDash([]);ctx.restore();

    // Arrow
    const ax=projX0+pW*.9,ad=isL?-1:1;
    ctx.fillStyle=isL?'#00e5a0':'#ff2d55';
    ctx.beginPath();ctx.moveTo(ax+8,t1y);ctx.lineTo(ax,t1y+ad*8);ctx.lineTo(ax,t1y-ad*8);ctx.closePath();ctx.fill();

    // "1:2" label
    const midZ=(ey+t1y)/2;
    if(Math.abs(p1b-p1t)>24){
      ctx.font='bold 14px Orbitron';
      ctx.fillStyle='rgba(245,200,66,.9)';
      ctx.textAlign='center';
      ctx.fillText('1:2',projX0+pW*.5,midZ+5);
      ctx.textAlign='left';
    }

    // ELITE signal badge (top of projection zone)
    const isEliteScore=a.score>=95;
    const badgeW=92,badgeH=20;
    const badgeX=projX0+(pW-badgeW)/2;
    const badgeY=isL?Math.max(PT+3,Math.min(ey,sy)-25):Math.min(PT+chartH-badgeH-3,Math.max(ey,sy)+5);
    const badgeBg=isL?'rgba(0,40,24,.95)':isEliteScore?'rgba(60,0,20,.95)':'rgba(40,0,12,.95)';
    const badgeAccent=isEliteScore?(isL?'rgba(245,200,66,.8)':'rgba(245,200,66,.8)'):(isL?'rgba(0,229,160,.7)':'rgba(255,45,85,.7)');
    ctx.fillStyle=badgeBg;ctx.fillRect(badgeX,badgeY,badgeW,badgeH);
    ctx.strokeStyle=badgeAccent;ctx.lineWidth=1;ctx.strokeRect(badgeX,badgeY,badgeW,badgeH);
    ctx.fillStyle=isEliteScore?'#f5c842':(isL?'#00e5a0':'#ff2d55');
    ctx.font='bold 8px Orbitron';ctx.textAlign='center';
    const bl=a.sigClass==='ELITE STRONG BUY'?'‚òÖ ELITE BUY':a.sigClass==='ELITE STRONG SELL'?'‚òÖ ELITE SELL':a.sigClass==='EARLY BUY'?'‚ñ≤ EARLY BUY':a.sigClass==='EARLY SELL'?'‚ñº EARLY SELL':'‚ßó BUILDING';
    ctx.fillText(`${bl}  ${a.score}%`,badgeX+badgeW/2,badgeY+13);
    ctx.textAlign='left';
    ctx.restore();
  }

  // WAIT badge
  if(a&&(a.dir==='WAIT'||a.dir==='CAUTION')){
    ctx.save();ctx.beginPath();ctx.rect(projX0,PT,projW,chartH);ctx.clip();
    ctx.fillStyle='rgba(8,12,24,.7)';ctx.fillRect(projX0,PT,projW,chartH);
    const bW=78,bH=20,bX=projX0+(projW-bW)/2,bY=PT+chartH/2-10;
    const isWS=a.dir==='CAUTION';
    ctx.fillStyle=isWS?'rgba(40,20,0,.95)':'rgba(6,10,20,.95)';ctx.fillRect(bX,bY,bW,bH);
    ctx.strokeStyle=isWS?'rgba(251,146,60,.5)':'rgba(56,189,248,.3)';ctx.lineWidth=.8;ctx.strokeRect(bX,bY,bW,bH);
    ctx.fillStyle=isWS?'#fb923c':'rgba(56,189,248,.7)';
    ctx.font='bold 8px Orbitron';ctx.textAlign='center';
    ctx.fillText(isWS?'‚ö† WHIPSAW':'‚ßó WAIT 95%+',bX+bW/2,bY+13);
    ctx.textAlign='left';ctx.restore();
  }

  // ‚îÄ‚îÄ BB BANDS ‚îÄ‚îÄ
  if(a&&a.bbLine){
    ctx.save();ctx.beginPath();ctx.rect(PL,PT,candW,chartH);ctx.clip();
    const bv=a.bbLine.slice(-VIS);
    ctx.strokeStyle='rgba(56,189,248,.18)';ctx.lineWidth=.9;ctx.setLineDash([3,3]);
    ['up','dn'].forEach(k=>{ctx.beginPath();let s=false;bv.forEach((b,i)=>{if(!b)return;const x=toX(i),y=toY(b[k]);s?ctx.lineTo(x,y):(ctx.moveTo(x,y),s=true);});ctx.stroke();});
    ctx.setLineDash([]);
    const vld=bv.map((b,i)=>({b,i})).filter(({b})=>b);
    if(vld.length>1){ctx.beginPath();vld.forEach(({b,i})=>ctx.lineTo(toX(i),toY(b.up)));[...vld].reverse().forEach(({b,i})=>ctx.lineTo(toX(i),toY(b.dn)));ctx.closePath();ctx.fillStyle='rgba(56,189,248,.03)';ctx.fill();}
    ctx.restore();
  }

  // ‚îÄ‚îÄ VWAP ‚îÄ‚îÄ
  if(a&&a.vwapLine){
    ctx.save();ctx.beginPath();ctx.rect(PL,PT,candW,chartH);ctx.clip();
    const vv=a.vwapLine.slice(-VIS);
    ctx.strokeStyle='rgba(245,200,66,.8)';ctx.lineWidth=1.4;ctx.setLineDash([5,3]);
    ctx.beginPath();let s=false;vv.forEach((v,i)=>{const x=toX(i),y=toY(v);s?ctx.lineTo(x,y):(ctx.moveTo(x,y),s=true);});
    ctx.stroke();ctx.setLineDash([]);ctx.restore();
  }

  // ‚îÄ‚îÄ EMAs ‚îÄ‚îÄ
  if(a){
    ctx.save();ctx.beginPath();ctx.rect(PL,PT,candW,chartH);ctx.clip();
    [{arr:a.e20,c:'rgba(0,229,160,.75)',lw:1.3},{arr:a.e50,c:'rgba(56,189,248,.55)',lw:1}].forEach(({arr,c,lw})=>{
      if(!arr)return;const v=arr.slice(-VIS);ctx.strokeStyle=c;ctx.lineWidth=lw;ctx.beginPath();let s=false;
      v.forEach((val,i)=>{if(!val)return;const x=toX(i),y=toY(val);s?ctx.lineTo(x,y):(ctx.moveTo(x,y),s=true);});ctx.stroke();
    });ctx.restore();
  }

  // ‚îÄ‚îÄ RANGE LINES ‚îÄ‚îÄ
  if(a){
    [{lv:a.rHigh,c:'rgba(255,45,85,.4)'},{lv:a.rLow,c:'rgba(0,229,160,.4)'}].forEach(({lv,c})=>{
      if(!lv)return;const y=toY(lv);if(y<PT||y>PT+chartH)return;
      ctx.strokeStyle=c;ctx.lineWidth=.7;ctx.setLineDash([7,4]);
      ctx.beginPath();ctx.moveTo(PL,y);ctx.lineTo(projX1,y);ctx.stroke();ctx.setLineDash([]);
    });
  }

  // ‚îÄ‚îÄ CANDLES ‚îÄ‚îÄ
  ctx.save();ctx.beginPath();ctx.rect(PL,PT,candW+2,chartH);ctx.clip();
  cands.forEach((c,i)=>{
    const x=toX(i),cw2=Math.max(2.5,xP*.70);
    const isG=c.c>=c.o;
    const bt=cY(toY(Math.max(c.o,c.c))),bb2=cY(toY(Math.min(c.o,c.c)));
    const bh=Math.max(1.5,bb2-bt);
    ctx.strokeStyle=isG?'#00b87c':'#cc1f3d';ctx.lineWidth=1.2;
    ctx.beginPath();ctx.moveTo(x,cY(toY(c.h)));ctx.lineTo(x,cY(toY(c.l)));ctx.stroke();
    ctx.fillStyle=isG?'rgba(0,210,110,.92)':'rgba(210,28,65,.92)';ctx.fillRect(x-cw2/2,bt,cw2,bh);
    ctx.strokeStyle=isG?'rgba(0,229,160,.5)':'rgba(255,45,85,.5)';ctx.lineWidth=.5;ctx.strokeRect(x-cw2/2,bt,cw2,bh);
    if(i===VIS-1){ctx.strokeStyle=isG?'#00e5a0':'#ff2d55';ctx.lineWidth=1.8;ctx.strokeRect(x-cw2/2-2,bt-2,cw2+4,bh+4);}
  });ctx.restore();

  // ‚îÄ‚îÄ PRICE SCALE ‚îÄ‚îÄ
  ctx.font='9px JetBrains Mono';ctx.textAlign='left';
  for(let i=0;i<=8;i++){
    const pv=pL+(pR/8)*i;const y=toY(pv);
    if(y<PT-5||y>H-PB+5)continue;
    ctx.fillStyle='rgba(40,75,120,.6)';ctx.fillText(fmt(pv,G.dec),projX1+4,y+3);
  }
  function ptag(price,bg,border,fg,label){
    if(!price)return;const y=toY(price);
    if(y<PT-14||y>H-PB+14)return;
    ctx.strokeStyle=border.replace(/[\d.]+\)$/,'.3)');ctx.lineWidth=.7;ctx.setLineDash([5,4]);
    ctx.beginPath();ctx.moveTo(PL,y);ctx.lineTo(projX1,y);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle=bg;ctx.fillRect(projX1+1,y-9,PCOL-2,18);
    ctx.strokeStyle=border;ctx.lineWidth=.9;ctx.strokeRect(projX1+1,y-9,PCOL-2,18);
    ctx.fillStyle=fg;ctx.font='bold 9px JetBrains Mono';
    ctx.fillText(`${label} ${fmt(price,G.dec)}`,projX1+4,y+3);
  }
  if(a&&(a.dir==='LONG'||a.dir==='SHORT')){
    const isL=a.dir==='LONG';
    ptag(a.tp2,'rgba(0,40,22,.92)','rgba(0,200,100,.6)','#00d070','T2');
    ptag(a.tp1,'rgba(0,55,28,.92)','rgba(0,229,160,.85)','#00e5a0','T1');
    ptag(a.sl,'rgba(65,0,18,.92)','rgba(255,45,85,.85)','#ff2d55','SL');
    const eb=isL?'rgba(0,35,60,.92)':'rgba(50,5,22,.92)';
    const ef=isL?'#38bdf8':'#ff7799';
    const ebd=isL?'rgba(56,189,248,.8)':'rgba(255,80,130,.8)';
    ptag(a.entry,eb,ebd,ef,'ENT');
    // ELITE SCORE TAG
    if(a.isElite){
      const sy2=PT+8;
      ctx.fillStyle='rgba(50,35,0,.95)';ctx.fillRect(projX1+1,sy2,PCOL-2,18);
      ctx.strokeStyle='rgba(245,200,66,.8)';ctx.lineWidth=1;ctx.strokeRect(projX1+1,sy2,PCOL-2,18);
      ctx.fillStyle='#f5c842';ctx.font='bold 8px Orbitron';
      ctx.fillText(`‚òÖ ${a.score}%`,projX1+4,sy2+12);
    }
  }
  // Live price
  if(G.price){
    const ly=toY(G.price);
    ctx.strokeStyle='rgba(56,189,248,.6)';ctx.lineWidth=1;ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.moveTo(PL,ly);ctx.lineTo(projX1,ly);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='#38bdf8';ctx.fillRect(projX1+1,ly-9,PCOL-2,18);
    ctx.fillStyle='#04060d';ctx.font='bold 9px JetBrains Mono';
    ctx.fillText(fmt(G.price,G.dec),projX1+4,ly+3);
  }
  // Score badge top-left
  if(a&&a.dir!=='WAIT'){
    const isL=a.dir==='LONG',isE=a.isElite;
    const bc=isE?'#f5c842':isL?'#00e5a0':'#ff2d55';
    ctx.fillStyle=isE?'rgba(40,28,0,.9)':isL?'rgba(0,35,20,.88)':'rgba(40,0,12,.88)';
    ctx.fillRect(PL,PT-20,165,18);
    ctx.strokeStyle=bc+'99';ctx.lineWidth=.7;ctx.strokeRect(PL,PT-20,165,18);
    ctx.fillStyle=bc;ctx.font='bold 9px Orbitron';
    const bl=a.dir==='LONG'?'‚ñ≤ LONG':'‚ñº SHORT';
    ctx.fillText(`${isE?'‚òÖ ':''} ${bl}  ${a.score}%  ${a.sigClass}`,PL+5,PT-7);
  }
  // Time labels
  ctx.fillStyle='rgba(40,65,100,.7)';ctx.font='8px JetBrains Mono';ctx.textAlign='center';
  cands.forEach((c,i)=>{if(i%5!==0)return;const d=new Date(c.t);ctx.fillText(`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`,toX(i),H-8);});
  ctx.textAlign='left';
}

function drawOI(){
  const cv=document.getElementById('oic'),pnl=document.getElementById('oi-pnl');
  cv.width=pnl.clientWidth;cv.height=pnl.clientHeight;
  const ctx=cv.getContext('2d'),W=cv.width,H=cv.height;
  ctx.fillStyle='#04060d';ctx.fillRect(0,0,W,H);
  if(!G.analysis)return;
  const PCOL=82,cW=W-PCOL;
  const deltas=G.analysis.oiDeltas.slice(-32);
  if(!deltas.length)return;
  const maxD=Math.max(...deltas.map(Math.abs),1);
  const bW=cW/deltas.length,midY=H/2;
  ctx.strokeStyle='rgba(28,45,69,.8)';ctx.lineWidth=.8;
  ctx.beginPath();ctx.moveTo(0,midY);ctx.lineTo(cW,midY);ctx.stroke();
  deltas.forEach((d,i)=>{
    const x=i*bW,h=Math.max(1,Math.abs(d)/maxD*(midY-5));
    ctx.fillStyle=d>=0?'rgba(0,200,100,.78)':'rgba(200,28,65,.78)';
    d>=0?ctx.fillRect(x+1,midY-h,bW-2,h):ctx.fillRect(x+1,midY,bW-2,h);
  });
  ctx.fillStyle='#060a14';ctx.fillRect(cW,0,PCOL,H);
  ctx.strokeStyle='rgba(28,45,69,.9)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(cW,0);ctx.lineTo(cW,H);ctx.stroke();
  const ld=deltas[deltas.length-1];
  ctx.fillStyle=ld>=0?'#00e5a0':'#ff2d55';ctx.font='bold 9px JetBrains Mono';ctx.textAlign='left';
  ctx.fillText((ld>=0?'+':'')+fmtK(ld),cW+4,H/2+4);
}

function drawVol(){
  const cv=document.getElementById('vc'),pnl=document.getElementById('vol-pnl');
  cv.width=pnl.clientWidth;cv.height=pnl.clientHeight;
  const ctx=cv.getContext('2d'),W=cv.width,H=cv.height;
  ctx.fillStyle='#04060d';ctx.fillRect(0,0,W,H);
  if(!G.c15.length)return;
  const PCOL=82,cW=W-PCOL;
  const cands=G.c15.slice(-32);
  const maxV=Math.max(...cands.map(c=>c.v),1);
  const avgV=cands.reduce((s,c)=>s+c.v,0)/cands.length||1;
  const bW=cW/cands.length;
  cands.forEach((c,i)=>{
    const x=i*bW,h=Math.max(1,c.v/maxV*(H-6));
    const br=c.qv>0?c.tqv/c.qv:.5;
    const col=br>.55?'rgba(0,200,100,.78)':br<.45?'rgba(200,28,65,.78)':'rgba(80,120,180,.45)';
    if(c.v>avgV*1.8){ctx.fillStyle=c.c>=c.o?'rgba(0,229,160,.07)':'rgba(255,45,85,.07)';ctx.fillRect(x,0,bW,H);}
    ctx.fillStyle=col;ctx.fillRect(x+1,H-h,bW-2,h);
  });
  ctx.fillStyle='#060a14';ctx.fillRect(cW,0,PCOL,H);
  ctx.strokeStyle='rgba(28,45,69,.9)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(cW,0);ctx.lineTo(cW,H);ctx.stroke();
  if(G.analysis){
    const c=G.analysis.volSpike?'#38bdf8':'rgba(60,90,140,.7)';
    ctx.fillStyle=c;ctx.font='bold 9px JetBrains Mono';ctx.textAlign='left';
    ctx.fillText(G.analysis.volRatio.toFixed(1)+'x',cW+4,H/2+4);
  }
}

// ‚ïê‚ïê‚ïê UI UPDATE ‚ïê‚ïê‚ïê
function updateUI(){
  const a=G.analysis;
  // Ticker
  if(G.price){
    const pEl=document.getElementById('tk-price');
    pEl.textContent='$'+G.price.toLocaleString('en-US',{minimumFractionDigits:G.dec,maximumFractionDigits:G.dec});
    pEl.className='tk-v '+(G.chg24>=0?'pos':'neg');
  }
  const cEl=document.getElementById('tk-chg');
  cEl.textContent=(G.chg24>=0?'+':'')+G.chg24.toFixed(2)+'%';
  cEl.className='tk-v '+(G.chg24>=0?'pos':'neg');
  const fEl=document.getElementById('tk-fund');
  fEl.textContent=(G.funding*100).toFixed(4)+'%';
  fEl.className='tk-v '+(G.funding>0.0003?'neg':G.funding<-0.0003?'pos':'neutral');
  document.getElementById('tk-oi').textContent=fmtK(G.currentOI);
  document.getElementById('tk-vol').textContent=fmtK(G.vol24);
  if(!a)return;

  // Chart header
  document.getElementById('ch-pair').textContent=G.sym.replace('USDT','/USDT')+' ¬∑ 15M';
  document.getElementById('ch-oid').textContent=(a.oiDelta>=0?'+':'')+fmtK(a.oiDelta);
  document.getElementById('ch-oid').style.color=a.oiDelta>=0?'var(--jade)':'var(--crimson)';
  document.getElementById('ch-vr').textContent=a.volRatio.toFixed(2)+'x';
  document.getElementById('ch-vr').style.color=a.volSpike?'var(--sky)':'var(--t2)';
  document.getElementById('ch-atr').textContent='$'+fmt(a.atrV,G.dec);
  document.getElementById('ch-bp').textContent=a.brkProb+'%';
  document.getElementById('ch-bp').style.color=a.brkProb>=70?'var(--jade)':a.brkProb>=50?'var(--amber)':'var(--t2)';
  document.getElementById('ch-rsi').textContent=a.rsiV?fmt(a.rsiV,1):'‚Äî';
  document.getElementById('ch-rsi').style.color=a.rsiV>70?'var(--crimson)':a.rsiV<30?'var(--jade)':'var(--t2)';
  const scoreEl=document.getElementById('ch-score');
  scoreEl.textContent=a.score+'%';
  scoreEl.style.color=a.score>=95?'var(--gold)':a.score>=80?'var(--jade)':a.score>=60?'var(--sky)':'var(--t2)';

  // Elite card
  const card=document.getElementById('elite-card');
  card.className='elite-card '+(a.dir==='LONG'?'long':a.dir==='SHORT'?'short':a.isElite?'armed':'');
  if(a.isElite)card.classList.add('armed');
  const signalEl=document.getElementById('ec-signal');
  signalEl.textContent=a.sigClass;
  signalEl.style.color=a.dir==='LONG'?'var(--jade)':a.dir==='SHORT'?'var(--crimson)':a.isElite?'var(--gold)':'var(--t2)';
  document.getElementById('ec-sub').textContent=a.cls;
  const dirEl=document.getElementById('ec-dir');
  dirEl.textContent=a.dir==='LONG'?'‚Üë':a.dir==='SHORT'?'‚Üì':'‚Äî';
  dirEl.style.color=a.dir==='LONG'?'var(--jade)':a.dir==='SHORT'?'var(--crimson)':a.isElite?'var(--gold)':'var(--t3)';

  // Probability bar
  const pct=a.score;
  const probFill=document.getElementById('prob-fill');
  probFill.style.width=pct+'%';
  const pColor=pct>=95?'linear-gradient(90deg,#d4a820,#f5c842,#fff8a0)':pct>=80?'linear-gradient(90deg,#00b87c,#00e5a0)':pct>=60?'linear-gradient(90deg,#1d7ab0,#38bdf8)':'var(--border3)';
  probFill.style.background=pColor;
  document.getElementById('prob-pct').textContent=pct+'%';
  document.getElementById('prob-pct').style.color=pct>=95?'var(--gold)':pct>=80?'var(--jade)':pct>=60?'var(--sky)':'var(--t3)';
  const tier=document.getElementById('prob-tier');
  tier.textContent=pct>=95?`‚òÖ ELITE SIGNAL ARMED ‚Äî ${a.confCount} CONFIRMATIONS ACTIVE`:pct>=80?`STRONG SETUP ‚Äî ${a.confCount} confirmations`:pct>=60?`BUILDING ‚Äî ${a.confCount} partial confirmations`:'STANDBY ‚Äî WAITING FOR CONFLUENCE';
  tier.style.color=pct>=95?'var(--gold)':pct>=80?'var(--jade)':pct>=60?'var(--sky)':'var(--t3)';

  // Gate badge
  const gate=document.getElementById('gate-badge');
  if(pct>=95){gate.className='confidence-gate armed';gate.textContent=`‚òÖ ${a.dir} ${pct}%`;}
  else{gate.className='confidence-gate standby';gate.textContent=`‚ßó ${pct}% / 95`;}

  // Confluence grid
  const confItems=[
    {key:'ema',label:'EMA 20/50 Pull',act:a.bullConf.some(c=>c.label.includes('EMA'))||a.bearConf.some(c=>c.label.includes('EMA')),dir:a.dir},
    {key:'vwap',label:'VWAP Reclaim',act:a.bullConf.some(c=>c.label.includes('VWAP'))||a.bearConf.some(c=>c.label.includes('VWAP')),dir:a.dir},
    {key:'rsi',label:'RSI Momentum',act:a.bullConf.some(c=>c.label.includes('RSI'))||a.bearConf.some(c=>c.label.includes('RSI')),dir:a.dir},
    {key:'brk',label:'Break & Retest',act:a.bullConf.some(c=>c.label.includes('Break'))||a.bearConf.some(c=>c.label.includes('Break')),dir:a.dir},
    {key:'sweep',label:'Liq Sweep',act:a.bullConf.some(c=>c.label.includes('Sweep'))||a.bearConf.some(c=>c.label.includes('Sweep')),dir:a.dir},
    {key:'delta',label:'Delta Volume',act:a.bullConf.some(c=>c.label.includes('Delta'))||a.bearConf.some(c=>c.label.includes('Delta')),dir:a.dir},
    {key:'oi',label:'OI Agreement',act:a.oiPattern!=='NEUTRAL',dir:a.dir},
    {key:'fund',label:'Funding Extreme',act:Math.abs(G.funding)>0.0003,dir:a.dir},
  ];
  document.getElementById('conf-grid').innerHTML=confItems.map(item=>`
    <div class="conf-item ${item.act?'active':''}">
      <div class="ci-label">${item.label}</div>
      <div class="ci-val" style="color:${item.act?(item.dir==='LONG'?'var(--jade)':'var(--crimson)'):'var(--t3)'}">${item.act?'‚úì ACTIVE':'‚óã PENDING'}</div>
    </div>`).join('');

  // Levels
  const d=G.dec;
  document.getElementById('lv-rr').textContent='1:2 / 1:3 RR';
  document.getElementById('lv-ent').textContent='$'+fmt(a.entry,d);
  document.getElementById('lv-ent').style.color=a.dir==='LONG'?'var(--sky)':'var(--amber)';
  document.getElementById('lv-sl').textContent='$'+fmt(a.sl,d);
  document.getElementById('lv-tp1').textContent='$'+fmt(a.tp1,d);
  document.getElementById('lv-tp2').textContent='$'+fmt(a.tp2,d);
  document.getElementById('lv-move').textContent='+'+fmt(a.projPct,2)+'%';
  document.getElementById('lv-move').style.color='var(--jade)';

  // OI
  document.getElementById('lp-fill').style.width=a.longPres+'%';
  document.getElementById('sp-fill').style.width=(100-a.longPres)+'%';
  document.getElementById('lp-pct').textContent=a.longPres+'%';
  document.getElementById('sp-pct').textContent=(100-a.longPres)+'%';
  const oiLookup={AGG_LONG:'Price‚Üë+OI‚Üë ‚Üí Long Build',AGG_SHORT:'Price‚Üì+OI‚Üë ‚Üí Short Build',SHORT_SQUEEZE:'Price‚Üë+OI‚Üì ‚Üí Squeeze',LONG_LIQ:'Price‚Üì+OI‚Üì ‚Üí Liquidation',NEUTRAL:'No Pattern'};
  document.getElementById('oi-event').textContent=oiLookup[a.oiPattern]||'‚Äî';
  document.getElementById('oi-event').style.color=a.dir==='LONG'?'var(--jade)':a.dir==='SHORT'?'var(--crimson)':'var(--t2)';
  document.getElementById('fund-state').textContent=G.funding>0.0003?'Long Crowd Risk':G.funding<-0.0003?'Short Squeeze Risk':'Neutral';
  document.getElementById('fund-state').style.color=G.funding>0.0003?'var(--crimson)':G.funding<-0.0003?'var(--jade)':'var(--t3)';

  // Events log
  const evList=a.evts.length?a.evts:[{c:'var(--t4)',t:'No notable smart-money events detected'}];
  document.getElementById('elog-list').innerHTML=evList.map(e=>`
    <div class="eitem">
      <div class="edot" style="background:${e.c}"></div>
      <div class="etxt">${e.t}</div>
      <div class="etime">${new Date().toLocaleTimeString()}</div>
    </div>`).join('');

  // MTF tab
  updateMTF(a);
  // Signals tab
  updateSigsTab(a);
  // History
  renderHistory();
  // JSON
  if(G.activeTab==='json')updateJSON(a);
}

function updateMTF(a){
  const bullTag='<div class="tag bull">BULL</div>',bearTag='<div class="tag bear">BEAR</div>',neuTag='<div class="tag neu">NEUTRAL</div>';
  document.getElementById('mtf-4h-detail').textContent=a.bias4h==='BULL'?'EMA9>21>45 ¬∑ Price above EMA21':a.bias4h==='BEAR'?'EMA9<21<45 ¬∑ Price below EMA21':'Alignment unclear';
  document.getElementById('mtf-4h-tag').outerHTML=`<div id="mtf-4h-tag">${a.bias4h==='BULL'?bullTag:a.bias4h==='BEAR'?bearTag:neuTag}</div>`;
  document.getElementById('mtf-4h-ema').textContent=`EMA9: ${fmt(a.v9,G.dec)}  21: ${fmt(a.v21,G.dec)}  45: ${fmt(a.v45,G.dec)}`;
  document.getElementById('mtf-1h-detail').textContent=a.bias1h==='BULL'?'Price above EMA200 ‚Äî Bull dominance':a.bias1h==='BEAR'?'Price below EMA200 ‚Äî Bear dominance':'EMA200 neutral';
  document.getElementById('mtf-1h-tag').outerHTML=`<div id="mtf-1h-tag">${a.bias1h==='BULL'?bullTag:a.bias1h==='BEAR'?bearTag:neuTag}</div>`;
  document.getElementById('mtf-1h-ema').textContent=`EMA200: ${fmt(a.v200,G.dec)}  |  Price: ${fmt(a.p1,G.dec)}`;
  const d15=a.dir==='LONG'?'Bull setup building':a.dir==='SHORT'?'Bear setup building':'Waiting for setup';
  document.getElementById('mtf-15m-detail').textContent=d15;
  document.getElementById('mtf-15m-tag').outerHTML=`<div id="mtf-15m-tag">${a.dir==='LONG'?bullTag:a.dir==='SHORT'?bearTag:neuTag}</div>`;
  document.getElementById('mtf-15m-rsi').textContent=`RSI(14): ${fmt(a.rsiV,1)}  |  VWAP: ${fmt(a.vwapV,G.dec)}  |  EMA20: ${fmt(a.e20v,G.dec)}`;
  document.getElementById('mtf-atr').textContent=`ATR(14): $${fmt(a.atrV,G.dec)}  |  Avg Range: $${fmt(a.atrV,G.dec)}`;
  document.getElementById('mtf-atr-tag').outerHTML=`<div id="mtf-atr-tag"><div class="tag ${a.isComp?'warn':'bull'}">${a.isComp?'COMPRESSED':'TRENDING'}</div></div>`;
  document.getElementById('mtf-vol').textContent=`Vol Ratio: ${a.volRatio.toFixed(2)}x  |  Taker Buy: ${(a.takerR*100).toFixed(0)}%`;
  document.getElementById('mtf-vol-tag').outerHTML=`<div id="mtf-vol-tag"><div class="tag ${a.volSpike?'gold':'neu'}">${a.volSpike?'SPIKE':'NORMAL'}</div></div>`;
  document.getElementById('mtf-ws').textContent=`Whipsaw: ${a.whipsaw?'DETECTED ‚Äî SIGNAL BLOCKED':'Clear'}  |  BrkProb: ${a.brkProb}%`;
  document.getElementById('mtf-ws-tag').outerHTML=`<div id="mtf-ws-tag"><div class="tag ${a.whipsaw?'warn':'bull'}">${a.whipsaw?'WARNING':'CLEAR'}</div></div>`;
  // Score breakdown
  document.getElementById('score-breakdown').innerHTML=a.scoreBD.map(b=>{
    const bv=Math.min(100,b.bullVal/b.max*100),bvr=Math.min(100,b.bearVal/b.max*100);
    const dom=bv>=bvr;
    return`<div class="mtf-row" style="padding:3px 9px">
      <div style="font-size:7px;color:var(--t3);width:90px;flex-shrink:0">${b.label}</div>
      <div style="flex:1;height:3px;background:rgba(255,255,255,.04);border-radius:2px;overflow:hidden;margin:0 4px">
        <div style="height:100%;width:${Math.max(bv,bvr)}%;background:${dom?'rgba(0,229,160,.7)':'rgba(255,45,85,.7)'};border-radius:2px"></div>
      </div>
      <div style="font-size:7px;color:${dom?'var(--jade)':'var(--crimson)'};width:28px;text-align:right">${Math.round(Math.max(bv,bvr))}%</div>
    </div>`;}).join('');
}

function updateSigsTab(a){
  if(!a||(a.dir==='WAIT'&&a.score<70)){
    document.getElementById('sig-list').innerHTML=`<div style="padding:12px 8px;font-size:8px;color:var(--t3);text-align:center">No elite signal yet.<br>Score must reach 95%+ with 4+ confirmations.</div>`;
    return;
  }
  const d=G.dec;
  const isL=a.dir==='LONG';
  document.getElementById('sig-list').innerHTML=`
    <div class="sig-item ${isL?'long':'short'}">
      <div class="si-header">
        <div class="si-pair">${G.sym.replace('USDT','')} / USDT</div>
        <div class="si-dir-badge ${isL?'long':'short'}">${isL?'‚ñ≤ LONG':'‚ñº SHORT'} ¬∑ ${a.score}%</div>
      </div>
      <div style="font-size:8px;color:${a.isElite?'var(--gold)':'var(--t2)'};margin-bottom:6px">${a.cls}</div>
      <div class="si-grid">
        <div class="si-row"><span class="si-lbl">ENTRY </span><span class="si-v">${fmt(a.entry,d)}</span></div>
        <div class="si-row"><span class="si-lbl">SL </span><span class="si-v" style="color:var(--crimson)">${fmt(a.sl,d)}</span></div>
        <div class="si-row"><span class="si-lbl">TP1 </span><span class="si-v" style="color:var(--jade)">${fmt(a.tp1,d)}</span></div>
        <div class="si-row"><span class="si-lbl">TP2 </span><span class="si-v" style="color:var(--jade2)">${fmt(a.tp2,d)}</span></div>
        <div class="si-row"><span class="si-lbl">CONFS </span><span class="si-v" style="color:var(--gold)">${a.confCount}</span></div>
        <div class="si-row"><span class="si-lbl">OI </span><span class="si-v">${a.oiPattern.replace(/_/g,' ')}</span></div>
      </div>
      <div style="font-size:7px;color:var(--t3);margin-top:6px">${new Date().toLocaleTimeString()}</div>
    </div>`;
}

function renderHistory(){
  const el=document.getElementById('hist-list');
  if(!G.history.length){el.innerHTML='<div style="padding:8px;font-size:8px;color:var(--t3)">No elite signals yet (score‚â•95% required)</div>';return;}
  el.innerHTML=G.history.map(r=>`
    <div class="htrow">
      <span style="color:var(--t3)">${r.time}</span>
      <span style="font-size:7px;color:var(--t2)">${(r.sym||G.sym).replace('USDT','')}</span>
      <span style="color:${r.dir==='LONG'?'var(--jade)':'var(--crimson)'}">${r.dir}</span>
      <span style="color:var(--gold)">${r.score}%</span>
      <span style="font-size:7px;color:${r.status==='ELITE'?'var(--gold)':'var(--t2)'}">${r.status}</span>
    </div>`).join('');
}

function updateJSON(a){
  if(!a)return;
  const obj={
    timestamp:new Date().toISOString(),
    engine:'GURU MASTER PRO ¬∑ OI FLOW ELITE',
    symbol:G.sym,
    signal:{
      direction:a.dir,class:a.sigClass,
      probability_score:a.score+'%',
      elite_threshold_met:a.score>=95,
      confirmation_count:a.confCount,
      classification:a.cls
    },
    multi_timeframe:{bias_4h:a.bias4h,bias_1h:a.bias1h,execution_15m:a.dir},
    trade_levels:{entry:+fmt(a.entry,G.dec),sl:+fmt(a.sl,G.dec),tp1:+fmt(a.tp1,G.dec),tp2:+fmt(a.tp2,G.dec),rr:'1:2/1:3'},
    indicators:{rsi14:a.rsiV?+fmt(a.rsiV,1):null,vwap:+fmt(a.vwapV,G.dec),atr14:+fmt(a.atrV,G.dec)},
    market_data:{funding_rate:(G.funding*100).toFixed(4)+'%',oi_delta:fmtK(a.oiDelta),oi_pattern:a.oiPattern,vol_ratio:a.volRatio.toFixed(2)+'x',breakout_prob:a.brkProb+'%'},
    confirmations:{bull:a.bullConf.map(c=>c.label),bear:a.bearConf.map(c=>c.label)},
    filters:{whipsaw_active:a.whipsaw,compression:a.isComp,signal_blocked:a.whipsaw||a.score<95},
    disclaimer:'EDUCATIONAL PURPOSES ONLY ‚Äî NOT FINANCIAL ADVICE'
  };
  document.getElementById('json-out').textContent=JSON.stringify(obj,null,2);
}


// ‚ïê‚ïê‚ïê BACKTEST + MONTE CARLO ‚ïê‚ïê‚ïê
async function runBacktest(){
  const periods=+document.getElementById('bt-period').value;
  document.getElementById('bt-status').style.display='block';
  document.getElementById('bt-status').textContent='Fetching historical data from Binance‚Ä¶';
  ['bt-metrics','bt-eq','monte-block','bt-gate','bt-log'].forEach(id=>{document.getElementById(id).style.display='none';});
  const kl=await apiFetch(`${FAPI}/fapi/v1/klines?symbol=${G.sym}&interval=15m&limit=${periods}`);
  if(!kl){document.getElementById('bt-status').textContent='Error: could not fetch data.';return;}
  document.getElementById('bt-status').textContent='Running elite backtest engine‚Ä¶';
  await new Promise(r=>setTimeout(r,60));
  const cands=kl.map(pk);
  const res=backtestEngine(cands);
  await new Promise(r=>setTimeout(r,60));
  document.getElementById('bt-status').textContent='Running Monte Carlo (500 simulations)‚Ä¶';
  const mc=monteCarloSim(res.trades,500);
  renderBTResults(res,mc);
  G.btResult={...res,mc};
}

function backtestEngine(cands){
  const cl=cands.map(c=>c.c);
  const e20a=ema(cl,20),e50a=ema(cl,50);
  const rsA=rsi14(cl),atrA=atr14(cands);
  const vwA=vwap(cands);
  const trades=[];let equity=10000;const curve=[equity];
  for(let i=60;i<cands.length-5;i++){
    const c=cands[i],p=cands[i-1];
    const e20v=e20a[i],e50v=e50a[i],rv=rsA[i],av=atrA[i],vv=vwA[i];
    if(!e20v||!e50v||!rv||!av)continue;
    // Require 4+ confirmations (simplified for backtest)
    let bConf=0,eConf=0;
    if(c.c>e20v&&c.c>e50v)bConf++;
    if(c.c>vv&&p.c<=vv)bConf++;
    if(rv>55)bConf++;
    if(c.c>Math.max(...cands.slice(i-7,i).map(x=>x.h)))bConf++;
    if(c.tqv/c.qv>.57)bConf++;
    let eConf2=0;
    if(c.c<e20v&&c.c<e50v)eConf2++;
    if(c.c<vv&&p.c>=vv)eConf2++;
    if(rv<45)eConf2++;
    if(c.c<Math.min(...cands.slice(i-7,i).map(x=>x.l)))eConf2++;
    if(c.tqv/c.qv<.43)eConf2++;
    // Whipsaw filter
    const bw=av/c.c;
    if(bw<0.0018)continue;
    let dir=null;
    if(bConf>=4)dir='LONG';
    else if(eConf2>=4)dir='SHORT';
    if(!dir)continue;
    const entry=c.c;
    const sl=dir==='LONG'?entry-av*1.4:entry+av*1.4;
    const tp=dir==='LONG'?entry+(entry-sl)*2:entry-(sl-entry)*2;
    const rsk=Math.abs(entry-sl);
    const size=(equity*0.02)/rsk;
    let result='LOSS',exitP=sl,dur=5;
    for(let j=i+1;j<=Math.min(i+10,cands.length-1);j++){
      const fc=cands[j];
      if(dir==='LONG'){if(fc.l<=sl){exitP=sl;dur=j-i;break;}if(fc.h>=tp){exitP=tp;result='WIN';dur=j-i;break;}}
      else{if(fc.h>=sl){exitP=sl;dur=j-i;break;}if(fc.l<=tp){exitP=tp;result='WIN';dur=j-i;break;}}
      exitP=fc.c;
    }
    const pnl=dir==='LONG'?(exitP-entry)*size:(entry-exitP)*size;
    equity=Math.max(100,equity+pnl);
    curve.push(equity);
    trades.push({dir,entry,sl,tp,exitP,result,pnl,dur,conf:Math.max(bConf,eConf2)});
  }
  const wins=trades.filter(t=>t.result==='WIN');
  const losses=trades.filter(t=>t.result==='LOSS');
  const winRate=trades.length?wins.length/trades.length*100:0;
  const gw=wins.reduce((s,t)=>s+t.pnl,0);
  const gl=Math.abs(losses.reduce((s,t)=>s+t.pnl,0))||1;
  const pf=gw/gl;
  const exp=trades.length?(equity-10000)/trades.length:0;
  let pk=10000,mdd=0;
  curve.forEach(e=>{if(e>pk)pk=e;const dd=(pk-e)/pk*100;if(dd>mdd)mdd=dd;});
  const rets=curve.slice(1).map((e,i)=>(e-curve[i])/curve[i]);
  const ar=rets.reduce((a,b)=>a+b,0)/(rets.length||1);
  const sr=Math.sqrt(rets.reduce((a,b)=>a+(b-ar)**2,0)/(rets.length||1));
  const sharpe=sr?ar/sr*Math.sqrt(252*6):0;
  return{trades,wins,losses,winRate,pf,mdd,sharpe,exp,equity,curve};
}

function monteCarloSim(trades,n=500){
  if(!trades.length)return{p95:0,p50:0,p5:0,worstDD:0};
  const results=[];
  for(let s=0;s<n;s++){
    const shuffled=[...trades].sort(()=>Math.random()-.5);
    let eq=10000;let pk=10000;let mdd=0;
    shuffled.forEach(t=>{eq=Math.max(100,eq+t.pnl);if(eq>pk)pk=eq;const dd=(pk-eq)/pk*100;if(dd>mdd)mdd=dd;});
    results.push({finalEq:eq,mdd});
  }
  results.sort((a,b)=>a.finalEq-b.finalEq);
  const mddArr=results.map(r=>r.mdd).sort((a,b)=>a-b);
  return{
    p95:results[Math.floor(n*.95)].finalEq,
    p50:results[Math.floor(n*.50)].finalEq,
    p5:results[Math.floor(n*.05)].finalEq,
    worstDD:mddArr[Math.floor(n*.95)],
    allEqs:results.map(r=>r.finalEq),
  };
}

function renderBTResults(r,mc){
  document.getElementById('bt-status').style.display='none';
  document.getElementById('bt-metrics').style.display='grid';
  document.getElementById('bt-eq').style.display='block';
  document.getElementById('monte-block').style.display='block';
  document.getElementById('bt-gate').style.display='block';
  document.getElementById('bt-log').style.display='block';
  const metricsData=[
    {label:'WIN RATE',val:r.winRate.toFixed(1)+'%',col:r.winRate>=60?'var(--jade)':r.winRate>=50?'var(--amber)':'var(--crimson)'},
    {label:'PROFIT FACTOR',val:r.pf.toFixed(2),col:r.pf>=1.5?'var(--jade)':r.pf>=1?'var(--amber)':'var(--crimson)'},
    {label:'MAX DRAWDOWN',val:r.mdd.toFixed(1)+'%',col:r.mdd<12?'var(--jade)':r.mdd<20?'var(--amber)':'var(--crimson)'},
    {label:'SHARPE RATIO',val:r.sharpe.toFixed(2),col:r.sharpe>=1.5?'var(--jade)':r.sharpe>=.5?'var(--amber)':'var(--crimson)'},
    {label:'EXPECTANCY',val:'$'+r.exp.toFixed(2),col:r.exp>=0?'var(--jade)':'var(--crimson)'},
    {label:'TOTAL TRADES',val:r.trades.length,col:'var(--sky)'},
  ];
  document.getElementById('bt-metrics').innerHTML=metricsData.map(m=>`
    <div class="bt-card"><div class="bt-lbl">${m.label}</div><div class="bt-val" style="color:${m.col}">${m.val}</div></div>`).join('');
  // Equity curve
  const cv=document.getElementById('bt-eq'),W=cv.width,H=cv.height;
  const ctx=cv.getContext('2d');
  ctx.fillStyle='#04060d';ctx.fillRect(0,0,W,H);
  const crv=r.curve,minE=Math.min(...crv),maxE=Math.max(...crv),eR=maxE-minE||1;
  const col=r.equity>10000?'var(--jade)':'var(--crimson)';
  ctx.strokeStyle=r.equity>10000?'rgba(0,229,160,.85)':'rgba(255,45,85,.85)';
  ctx.lineWidth=1.5;ctx.beginPath();
  crv.forEach((e,i)=>{const x=4+(W-8)*i/(crv.length-1),y=H-4-(e-minE)/eR*(H-8);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.stroke();
  const gc=ctx.createLinearGradient(0,0,0,H);
  gc.addColorStop(0,r.equity>10000?'rgba(0,229,160,.18)':'rgba(255,45,85,.18)');
  gc.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=gc;ctx.lineTo(W-4,H-4);ctx.lineTo(4,H-4);ctx.closePath();ctx.fill();
  // Final equity label
  ctx.fillStyle=r.equity>10000?'#00e5a0':'#ff2d55';ctx.font='bold 9px JetBrains Mono';ctx.textAlign='right';
  ctx.fillText('$'+Math.round(r.equity),W-5,14);ctx.textAlign='left';
  // Monte Carlo
  const monteRows=[
    {label:'95th Percentile',val:'$'+Math.round(mc.p95),fill:Math.min(100,mc.p95/20000*100),col:'var(--jade)'},
    {label:'Median (50th)',val:'$'+Math.round(mc.p50),fill:Math.min(100,mc.p50/20000*100),col:'var(--sky)'},
    {label:'5th Percentile',val:'$'+Math.round(mc.p5),fill:Math.min(100,Math.max(0,mc.p5/20000*100)),col:'var(--amber)'},
    {label:'Worst DD (95th)',val:mc.worstDD.toFixed(1)+'%',fill:Math.min(100,mc.worstDD*3),col:'var(--crimson)'},
  ];
  document.getElementById('monte-rows').innerHTML=monteRows.map(m=>`
    <div class="monte-bar-row">
      <div class="monte-lbl">${m.label}</div>
      <div class="monte-bar"><div class="monte-fill" style="width:${m.fill}%;background:${m.col}"></div></div>
      <div class="monte-num" style="color:${m.col}">${m.val}</div>
    </div>`).join('');
  // Elite gate check
  const gate=document.getElementById('bt-gate');
  const passWR=r.winRate>=55,passPF=r.pf>=1.5,passMDD=r.mdd<20,passSharpe=r.sharpe>=0.8;
  const passed=passWR&&passPF&&passMDD;
  gate.style.background=passed?'rgba(0,229,160,.06)':'rgba(255,45,85,.06)';
  gate.style.border=`1px solid ${passed?'rgba(0,229,160,.3)':'rgba(255,45,85,.3)'}`;
  gate.style.color=passed?'var(--jade)':'var(--crimson)';
  gate.innerHTML=`<b style="font-family:var(--orb)">${passed?'‚òÖ ELITE THRESHOLD MET ‚Äî LIVE MODE UNLOCKED':'‚ö† DOES NOT MEET ELITE THRESHOLDS'}</b><br>
    Win Rate: ${r.winRate.toFixed(1)}% ${passWR?'‚úì':'‚úó (need ‚â•55%)'}<br>
    Profit Factor: ${r.pf.toFixed(2)} ${passPF?'‚úì':'‚úó (need ‚â•1.5)'}<br>
    Max Drawdown: ${r.mdd.toFixed(1)}% ${passMDD?'‚úì':'‚úó (need <20%)'}<br>
    Sharpe: ${r.sharpe.toFixed(2)} ${passSharpe?'‚úì':'(target ‚â•0.8)'}`;
  document.getElementById('bt-log').innerHTML=`
    <div style="color:var(--t3);margin-bottom:4px">SIMULATION SUMMARY</div>
    <div>Total Trades: <b style="color:var(--t0)">${r.trades.length}</b> &nbsp; Winners: <b style="color:var(--jade)">${r.wins.length}</b> &nbsp; Losers: <b style="color:var(--crimson)">${r.losses.length}</b></div>
    <div>Final Equity: <b style="color:${r.equity>10000?'var(--jade)':'var(--crimson)'}">$${Math.round(r.equity)}</b> (started $10,000, 2% risk/trade)</div>
    <div style="color:var(--t3);font-size:7px;margin-top:4px">‚ö† Simulated backtest. Past results do not guarantee future performance.</div>`;
}

// ‚ïê‚ïê‚ïê TELEGRAM ‚ïê‚ïê‚ïê
async function sendTelegram(rec,sym,dec){
  if(!G.tg.enabled||!G.tg.token||!G.tg.chat)return;
  const now=Date.now();
  const f=ms=>{const m=Math.floor(ms/60000),s=Math.floor(ms%60000/1000);return`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;};
  const r15=900000-(now%900000),r1h=3600000-(now%3600000);
  const isL=rec.dir==='LONG';
  const star=rec.score>=95?'‚òÖ ELITE ':'';
  const msg=
    `${isL?'üü¢':'üî¥'} *${star}GURU MASTER PRO*\n`+
    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`+
    `üìä *${(sym||G.sym).replace('USDT','')}/USDT*  ${isL?'‚ñ≤ LONG':'‚ñº SHORT'}\n`+
    `üèÜ *${rec.sigClass||rec.cls}*\n`+
    `\n`+
    `*üìê TRADE LEVELS*\n`+
    `Entry:  \`${fmt(rec.entry,dec||G.dec)}\`\n`+
    `Stop:   \`${fmt(rec.sl,dec||G.dec)}\` üõë\n`+
    `TP1:    \`${fmt(rec.tp1,dec||G.dec)}\` ‚Üê 1:2 RR\n`+
    `TP2:    \`${fmt(rec.tp2,dec||G.dec)}\` ‚Üê 1:3 RR\n`+
    `\n`+
    `*üß† CONFLUENCE*\n`+
    `Score: *${rec.score}%* (threshold: 95%)\n`+
    `Confirmations: *${rec.confCount}+*\n`+
    `4H Bias: *${rec.bias4h}*  ‚îÇ  1H Bias: *${rec.bias1h}*\n`+
    `OI Pattern: ${(rec.oiPattern||'').replace(/_/g,' ')}\n`+
    `Funding: ${rec.funding!==undefined?(rec.funding*100).toFixed(4)+'%':'‚Äî'}\n`+
    `\n`+
    `‚è∞ 15M closes: *${f(r15)}*\n`+
    `‚è∞ 1H closes:  *${f(r1h)}*\n`+
    `üïê ${rec.time}\n`+
    `\n`+
    `_‚ö† Educational only ‚Äî NOT financial advice_`;
  try{
    await fetch(`https://api.telegram.org/bot${G.tg.token}/sendMessage`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({chat_id:G.tg.chat,text:msg,parse_mode:'Markdown'})
    });
  }catch(e){console.warn('TG:',e);}
}

async function testTelegram(){
  saveTgConfig();
  if(!G.tg.token||!G.tg.chat){
    showTgStatus('err','‚ö† Enter bot token and chat ID first.');return;
  }
  const msg=`‚úÖ *GURU MASTER PRO* ‚Äî Test\nConnected! Elite alerts active.\nSymbol: *${G.sym}*\nMin score: 95% ¬∑ Min confirmations: 4+\n_‚ö† Educational only._`;
  try{
    const r=await fetch(`https://api.telegram.org/bot${G.tg.token}/sendMessage`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({chat_id:G.tg.chat,text:msg,parse_mode:'Markdown'})
    });
    const d=await r.json();
    if(d.ok)showTgStatus('ok','‚úÖ Test message sent!');
    else showTgStatus('err','Error: '+d.description);
  }catch{showTgStatus('err','Network error. Check token + chat ID.');}
}

function saveTgConfig(){
  const token=document.getElementById('tg-token').value.trim();
  const chat=document.getElementById('tg-chat').value.trim();
  const enabled=document.getElementById('tg-enable').checked;
  const st=document.getElementById('tg-status');
  if(!token&&!chat){showTgStatus('err','‚ö† Enter token and chat ID first.');return;}
  if(enabled&&!token){showTgStatus('err','‚ö† Bot token required to enable alerts.');return;}
  if(enabled&&!chat){showTgStatus('err','‚ö† Chat ID required to enable alerts.');return;}
  G.tg={token,chat,enabled};
  try{localStorage.setItem('guru_token',token);localStorage.setItem('guru_chat',chat);localStorage.setItem('guru_enabled',enabled?'1':'0');}catch{}
  showTgStatus('ok',`‚úÖ Saved! ${enabled?'üîî Alerts ENABLED ‚Äî fires at 95%+ score with 4+ confirmations':'üîï Alerts DISABLED'}`);
  setTimeout(()=>{st.className='';st.style.display='none';},5000);
}

function showTgStatus(type,msg){
  const st=document.getElementById('tg-status');
  st.className=type;st.textContent=msg;st.style.display='block';
}

function restoreTgConfig(){
  try{
    const t=localStorage.getItem('guru_token')||'';
    const c=localStorage.getItem('guru_chat')||'';
    const e=localStorage.getItem('guru_enabled')==='1';
    if(t)document.getElementById('tg-token').value=t;
    if(c)document.getElementById('tg-chat').value=c;
    document.getElementById('tg-enable').checked=e;
    G.tg={token:t,chat:c,enabled:e};
  }catch{}
}

// ‚ïê‚ïê‚ïê MULTI-SYMBOL BACKGROUND SCANNER ‚ïê‚ïê‚ïê
const ALL_SYMS=[
  {sym:'ETHUSDT',dec:2},{sym:'BTCUSDT',dec:1},
  {sym:'SOLUSDT',dec:2},{sym:'BNBUSDT',dec:3},{sym:'XRPUSDT',dec:4}
];

async function bgAnalyzeSym(sym){
  const [kl,fr]=await Promise.all([
    apiFetch(`${FAPI}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=80`),
    apiFetch(`${FAPI}/fapi/v1/fundingRate?symbol=${sym}&limit=3`),
  ]);
  if(!kl||kl.length<55)return null;
  const c15=kl.map(pk);
  const funding=(fr&&fr.length)?+fr[fr.length-1].fundingRate:0;
  const N=c15.length-1,last=c15[N],prev=c15[N-1]||last;
  const cl=c15.map(c=>c.c);
  const e20a=ema(cl,20),e50a=ema(cl,50);
  const va=vwap(c15),rsA=rsi14(cl),atrA=atr14(c15);
  const e20v=e20a[N],e50v=e50a[N],vv=va[N],rv=rsA[N],av=atrA[N]||(last.h-last.l);
  const hi=c15.map(c=>c.h),lo=c15.map(c=>c.l);
  let bConf=0,eConf=0;
  if(e20v&&e50v&&last.c>e20v&&last.c>e50v)bConf++;
  if(last.c>vv&&prev.c<=vv)bConf++;
  if(rv&&rv>55)bConf++;
  if(last.c>Math.max(...hi.slice(-7,-1)))bConf++;
  if(c15[N].qv>0&&c15[N].tqv/c15[N].qv>.57)bConf++;
  if(e20v&&e50v&&last.c<e20v&&last.c<e50v)eConf++;
  if(last.c<vv&&prev.c>=vv)eConf++;
  if(rv&&rv<45)eConf++;
  if(last.c<Math.min(...lo.slice(-7,-1)))eConf++;
  if(c15[N].qv>0&&c15[N].tqv/c15[N].qv<.43)eConf++;
  const dojiN=c15.slice(-4).filter(c=>{const b=Math.abs(c.c-c.o),r=c.h-c.l;return r>av*.8&&b<r*.3;}).length;
  if(dojiN>=2)return null;
  const totalConf=Math.max(bConf,eConf);
  if(totalConf<4)return null;
  const bullScore=bConf*15+(funding<-0.0003?8:0);
  const bearScore=eConf*15+(funding>0.0003?8:0);
  const maxS=Math.max(bullScore,bearScore);
  const score=Math.min(97,Math.round(maxS/75*97));
  if(score<95)return null;
  const dir=bConf>=eConf?'LONG':'SHORT';
  const rHigh=Math.max(...hi.slice(-10)),rLow=Math.min(...lo.slice(-10));
  const entry=last.c,atrBuf=av*.35;
  const sl=dir==='LONG'?rLow-atrBuf:rHigh+atrBuf;
  const tp1=dir==='LONG'?entry+(entry-sl)*2:entry-(sl-entry)*2;
  const tp2=dir==='LONG'?entry+(entry-sl)*3:entry-(sl-entry)*3;
  return{dir,score,entry,sl,tp1,tp2,confCount:totalConf,sigClass:`ELITE STRONG ${dir==='LONG'?'BUY':'SELL'}`,
    cls:`üèÜ ELITE STRONG ${dir==='LONG'?'BUY':'SELL'} ‚Äî Full Alignment`,
    oiPattern:'NEUTRAL',bias4h:'‚Äî',bias1h:'‚Äî',funding,time:new Date().toLocaleTimeString()};
}

async function runBgScan(){
  if(!G.tg.enabled)return;
  const results=[];
  for(const {sym,dec} of ALL_SYMS){
    try{
      const res=await bgAnalyzeSym(sym);
      const cool=G.lastAlert[sym]||0;
      let fired=false;
      if(res&&Date.now()-cool>300000){
        G.lastAlert[sym]=Date.now();
        const rec={...res,sym,status:'ELITE',id:Date.now()};
        G.history.unshift(rec);if(G.history.length>100)G.history.pop();
        await sendTelegram(rec,sym,dec);
        fired=true;
        console.log(`[GURU] Elite signal fired: ${sym} ${res.dir} ${res.score}%`);
      }
      results.push({sym,fired,score:res?.score||0});
    }catch(e){results.push({sym,fired:false,score:0});}
    await new Promise(r=>setTimeout(r,1000));
  }
  const hits=results.filter(r=>r.fired);
  const badge=document.getElementById('scan-badge');
  if(badge){
    badge.textContent=hits.length?`‚ö° ${hits.length} elite alert(s): ${hits.map(r=>r.sym.replace('USDT','')).join(', ')}`:`‚úì Scanned 5 pairs ‚Äî no 95%+ signals`;
    badge.style.color=hits.length?'var(--gold)':'var(--t3)';
  }
  if(G.activeTab==='hist')renderHistory();
}

// ‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê
function exportCSV(){
  if(!G.history.length){alert('No signals yet.');return;}
  const h='Time,Symbol,Direction,Score,Class,Entry,SL,TP1,TP2,OI,Status';
  const rows=G.history.map(r=>`${r.time},${r.sym||G.sym},${r.dir},${r.score}%,"${r.sigClass||''}",${r.entry||''},${r.sl||''},${r.tp1||''},${r.tp2||''},${r.oiPattern||''},${r.status}`);
  dl([h,...rows].join('\n'),'guru_signals.csv','text/csv');
}
function exportJSON_(){
  if(!G.history.length){alert('No signals yet.');return;}
  dl(JSON.stringify(G.history,null,2),'guru_signals.json','application/json');
}
function clearHist(){if(confirm('Clear all history?')){G.history=[];renderHistory();}}
function dl(data,name,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();}

// ‚ïê‚ïê‚ïê TAB SYSTEM ‚ïê‚ïê‚ïê
function showTab(el,name){
  G.activeTab=name;
  document.querySelectorAll('.pane').forEach(p=>p.classList.remove('act'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('act'));
  document.getElementById('pane-'+name).classList.add('act');
  el.classList.add('act');
  if(name==='json'&&G.analysis)updateJSON(G.analysis);
}
function setSym(sym,el){
  G.sym=sym;G.c15=[];G.c1h=[];G.c4h=[];G.oiHist=[];G.analysis=null;
  document.querySelectorAll('.sb').forEach(b=>b.classList.remove('act'));
  el.classList.add('act');
  document.getElementById('lov').style.display='flex';
  document.getElementById('lstat').textContent='Loading '+sym+'‚Ä¶';
  document.getElementById('lbar').style.width='5%';
  loadAll();
}

// ‚ïê‚ïê‚ïê RENDER LOOP ‚ïê‚ïê‚ïê
function renderAll(){drawChart();drawOI();drawVol();updateUI();}
let rszt;
window.addEventListener('resize',()=>{clearTimeout(rszt);rszt=setTimeout(renderAll,100);});
setInterval(refreshQuick,15000);
setInterval(loadAll,300000);
setInterval(runBgScan,90000);
setTimeout(runBgScan,12000);

window.addEventListener('DOMContentLoaded',()=>{
  restoreTgConfig();
  loadAll();
  startCountdowns();
});

</script>
</body>
</html>